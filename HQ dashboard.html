<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµìœ¡ í˜„í™© ëŒ€ì‹œë³´ë“œ - FPCBì‚¬ì—…ë³¸ë¶€</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        .custom-scroll{overflow-y:auto;-webkit-overflow-scrolling:touch}.custom-scroll::-webkit-scrollbar{width:8px}.custom-scroll::-webkit-scrollbar-thumb{background-color:#cbd5e1;border-radius:4px}.custom-scroll::-webkit-webkit-scrollbar-track{background-color:#f1f5f9}.detail-content{transition:max-height .3s ease-out,opacity .3s ease-out,padding .3s ease-out;max-height:0;overflow:hidden;opacity:0;padding:0 1rem}.detail-content.show{max-height:500px;opacity:1;padding-top:1rem;padding-bottom:1rem}
    </style>
    <script>
        tailwind.config={theme:{extend:{fontFamily:{sans:['Inter','Noto Sans KR','sans-serif']},}}}
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Variables & Constants
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        let app, db, auth;
        
        const API_KEY='AIzaSyAybqaxn2n1BTB8GKql0c2xBaktc7QkLD0';
        const SPREADSHEET_ID='1JaxcSgP7amAT8N1sM2aa9TbxFAXjY6k9NAay49TyIyc'; 
        const EXTERNAL_RANGE='ì‚¬ì™¸êµìœ¡!A1:V100';
        const ALWAYS_ON_RANGE='ìƒì‹œí•™ìŠµì§€ì›!A1:V100';
        const ERP_RANGE='ERP!A1:D100';
        const MANDATORY_MINIMUM_HOURS=12;
        const CURRENT_DEPARTMENT='FPCBì‚¬ì—…ë³¸ë¶€';
        const ALL_TEAMS = ['í’ˆì§ˆê²½ì˜íŒ€', 'ì „ì¥ì‚¬ì—…íŒ€', 'ë©”ì¹´íŠ¸ë¡œë‹‰ìŠ¤íŒ€', 'ì˜ì—…íŒ€', 'í†µí•©êµ¬ë§¤íŒ€', 'FPCBì‚¬ì–‘íŒ€', 'ê°œë°œíŒ€', 'ì¤‘ì•™ì—°êµ¬ì†Œ'];
        const QUALITY_TEAM_EXTERNAL_URL = 'file:///C:/Users/User/Desktop/%EB%AF%BC%EB%8F%99%ED%98%81/13%EC%A3%BC%EC%B0%A8/%ED%99%88%ED%8E%98%EC%9D%B4%EC%A7%80%20%EB%A7%8C%EB%93%A4%EA%B8%B0/FPCB%EC%82%AC%EC%97%85%EB%B3%B8%EB%B6%80%20%ED%92%88%EC%A7%88%EA%B2%BD%EC%98%81%ED%8C%80.html';
        const EMPLOYEE_SUMMARY_PLACEHOLDER = '<p class="text-center text-gray-600 p-4 pt-16">ê·¸ë˜í”„ ìœ„ì— ì»¤ì„œë¥¼ ì˜¬ë ¤ íŒ€ë³„ ì†Œì† ì¸ì›ì„ í™•ì¸í•˜ì„¸ìš”.</p>';

        // ì¶”ê°€: íŒ€ë³„ êµ¬ì²´ì ì¸ ëª©í‘œ ì‹œê°„ (ì˜ˆì‹œ ë°ì´í„°)
        const MOCK_TEAM_GOAL_DETAILS = {
            'í’ˆì§ˆê²½ì˜íŒ€': [{name: 'ISO/í’ˆì§ˆí‘œì¤€ êµìœ¡', hours: 15}, {name: 'AI ê¸°ë°˜ ë¶ˆëŸ‰ ì˜ˆì¸¡', hours: 10}],
            'ì „ì¥ì‚¬ì—…íŒ€': [{name: 'ì°¨ì„¸ëŒ€ ì „ì¥ ê¸°ìˆ  ì‹¬í™”', hours: 12}, {name: 'í”„ë¡œì íŠ¸ ê´€ë¦¬(PM)', hours: 8}],
            'ë©”ì¹´íŠ¸ë¡œë‹‰ìŠ¤íŒ€': [{name: 'ì •ë°€ ì œì–´ ì‹œìŠ¤í…œ', hours: 20}, {name: 'ê³µì • ìë™í™”', hours: 5}],
            'ì˜ì—…íŒ€': [{name: 'í•´ì™¸ ì‹œì¥ ë¶„ì„', hours: 10}, {name: 'ê³ ê° í˜‘ìƒ ìŠ¤í‚¬', hours: 5}],
            'í†µí•©êµ¬ë§¤íŒ€': [{name: 'ê³µê¸‰ë§ ë¦¬ìŠ¤í¬ ê´€ë¦¬', hours: 12}, {name: 'ê¸€ë¡œë²Œ ì†Œì‹± ì „ëµ', hours: 8}],
            'FPCBì‚¬ì–‘íŒ€': [{name: 'FPCB ì„¤ê³„ ê¸°ì¤€ ì´í•´', hours: 15}, {name: 'ì‹ ì†Œì¬ ë¶„ì„', hours: 10}],
            'ê°œë°œíŒ€': [{name: 'ì„ë² ë””ë“œ SW ê°œë°œ', hours: 18}, {name: 'ì‹ ë¢°ì„± í…ŒìŠ¤íŠ¸', hours: 7}],
            'ì¤‘ì•™ì—°êµ¬ì†Œ': [{name: 'R&D ë…¼ë¬¸ ì‘ì„±ë²•', hours: 20}, {name: 'íŠ¹í—ˆ ì¶œì› ë° ê´€ë¦¬', hours: 15}],
            'ë¯¸ì •': [{name: 'ê¸°ì´ˆ ì§ë¬´ ì§€ì‹', hours: 10}],
            'ê¸°íƒ€': [{name: 'ë²•ì • ì˜ë¬´ êµìœ¡', hours: 10}]
        };

        let employeeGoalMap = {};
        let allEducationData=[];
        let allAlwaysOnData=[];
        let fullDeptData = [];
        let currentTeam = 'ì „ì²´';
        let employeeChartInstance = null; 
        let achievementChartInstance = null;

        const incidentalCostChartContainer=document.getElementById('incidentalCostChartDetailContainer');
        const costDetailChartDetailContainer = document.getElementById('costDetailChartDetailContainer'); 
        const achievementChartDetailContainer = document.getElementById('achievementChartDetailContainer'); 
        const DEPARTMENT_COLORS={'FPCBì‚¬ì—…ë³¸ë¶€':'rgb(16, 185, 129)','FSì‚¬ì—…ë³¸ë¶€':'rgb(59, 130, 246)','ê²½ì˜ì§€ì›ë³¸ë¶€':'rgb(250, 204, 21)','ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€':'rgb(99, 102, 241)','ê¸°íƒ€':'rgb(107, 114, 128)'};
        const TEAM_CHART_COLORS = {
            'í’ˆì§ˆê²½ì˜íŒ€': 'rgb(234, 88, 12)', 'ì „ì¥ì‚¬ì—…íŒ€': 'rgb(59, 130, 246)', 'ë©”ì¹´íŠ¸ë¡œë‹‰ìŠ¤íŒ€': 'rgb(16, 185, 129)',
            'ì˜ì—…íŒ€': 'rgb(168, 85, 247)', 'í†µí•©êµ¬ë§¤íŒ€': 'rgb(249, 115, 22)', 'FPCBì‚¬ì–‘íŒ€': 'rgb(234, 179, 8)',
            'ê°œë°œíŒ€': 'rgb(132, 204, 22)', 'ì¤‘ì•™ì—°êµ¬ì†Œ': 'rgb(236, 72, 153)', 'ë¯¸ì •': 'rgb(107, 114, 128)', 'ê¸°íƒ€': 'rgb(148, 163, 184)'
        };

        // Firebase Auth
        if(firebaseConfig){
            app=initializeApp(firebaseConfig);
            db=getFirestore(app);
            auth=getAuth(app);
            async function authenticate(){
                try{
                    if(initialAuthToken){await signInWithCustomToken(auth,initialAuthToken)}
                    else{await signInAnonymously(auth)}
                }catch(error){console.error("Firebase authentication error:",error)}
            }
            authenticate();
        }else{console.warn("Firebase config not found. Skipping Firebase initialization.")}
        
        // --- Utility Functions ---
        function formatCurrency(n){return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',minimumFractionDigits:0}).format(n)}
        
        function parseDateSort(s){
            if (!s) return 0; // FIX: s(periodString)ê°€ undefinedì¼ ê²½ìš° 0 ë°˜í™˜
            const match=s.match(/(\d{4})\.(\d{2})/);
            return match?parseInt(match[1]+match[2],10):0;
        }

        function parseHours(s){
            if(!s)return 0;
            let h=0;
            let m;
            m=s.match(/(\d+(\.\d+)?)\s*ì‹œê°„/);
            if(m){h+=parseFloat(m[1])}
            m=s.match(/(\d+)\s*ë¶„/);
            if(m){h+=parseInt(m[1])/60}
            if(h===0){m=s.match(/^(\d+(\.\d+)?)$/);if(m){h=parseFloat(m[1])}}
            return parseFloat(h.toFixed(2));
        }

        function parseCurrency(s){
             if(!s)return 0;
             const c=s.trim().toLowerCase();
             if(c.includes('ë¬´ë£Œ')||c.includes('ë¬´ìƒ')||c==='0ì›'){return 0}
             const n=c.replace(/ì›/g,'').replace(/,/g,'').trim();
             const cost=parseFloat(n);
             return isNaN(cost)?0:cost;
        }

        function toggleDetail(element){ 
            const container=element.tagName==='H2'?element.closest('#mandatoryComplianceContainer'):element;
            const detailContainer=container.querySelector('.detail-content');
            const arrowIcon=container.querySelector('.toggle-icon');
            const isShow=detailContainer.classList.contains('show');
            document.querySelectorAll('.detail-content.show').forEach(openDetail=>{
                openDetail.classList.remove('show');
                const parent=openDetail.closest('.kpi-card,.education-item,#mandatoryComplianceContainer,.team-topic-item');
                const openArrow=parent?.querySelector('.toggle-icon');
                if(openArrow)openArrow.classList.remove('rotate-180');
            });
            if(!isShow){detailContainer.classList.add('show');if(arrowIcon)arrowIcon.classList.add('rotate-180')}
        }
        window.toggleDetail = toggleDetail; 

        function closeDetailModal() {
            document.getElementById('educationModal').classList.add('hidden');
        }
        window.closeDetailModal = closeDetailModal;

        // Mocking functions
        function mockTeamAssignment(data) {
            const teams = ALL_TEAMS;
            const teamMap = {};
            const employeesInDept = [...new Set(data.filter(item => item.dept === CURRENT_DEPARTMENT).map(item => item.employeeId))];
            employeesInDept.forEach((id, index) => {
                teamMap[id] = teams[index % teams.length];
                if (!employeeGoalMap[id]) { employeeGoalMap[id] = Math.floor(Math.random() * (30 - 12 + 1)) + 12; }
            });
            return data.map(item => {
                item.team = item.dept === CURRENT_DEPARTMENT ? (teamMap[item.employeeId] || 'ë¯¸ì •') : 'N/A';
                item.goalHours = item.dept === CURRENT_DEPARTMENT ? (employeeGoalMap[item.employeeId] || 0) : 0;
                return item;
            });
        }

        // Data Processing Functions
        function processERPData(sheetValues){
            const map={};
            sheetValues.slice(1).forEach(row=>{
                const id=row[0]?.trim();
                const dept=row[2]?.trim();
                const email=row[3]?.trim()||'ì´ë©”ì¼ ë¯¸ë“±ë¡';
                if(id){map[id]={dept:dept||'ê¸°íƒ€',email:email}}
            });
            return map;
        }

        function processSheetData(sheetValues,sourceName,erpMap={}){
            const C={c:0, n:1, id:2, s:4, h:5, t:6, p:7, hS:8, cS:9, rR:10, cnt:11, prp:12, eff:13, sum:14, lkg:15, dif:16, iD:17, car:18, pub:19, lod:20, total:21};
            if(sheetValues.length<=1)return [];
            return sheetValues.slice(1).map((row,i)=>{
                const id=row[C.id]||`E${i+1}`;
                const erp=erpMap[id];
                return{
                    id:`${sourceName}-${i+1}`, period:row[C.p]||'N/A', position:erp?.position || 'ë¯¸ì •', 
                    type:row[C.t]||'ë¯¸ì •', subject:row[C.s]||'ì œëª© ì—†ìŒ', host:row[C.h]||'ë¯¸ì •',
                    dept:erp?.dept || 'ê¸°íƒ€', source:sourceName,
                    isCompleted:(row[C.c]||'').toUpperCase()==='ì™„ë£Œ'||(row[C.c]||'').includes('ì™„ë£Œ'),
                    employeeName:row[C.n]||'ì´ë¦„ ì—†ìŒ', employeeId:id,
                    actualHours:parseHours(row[C.hS]||'0'), actualCost:parseCurrency(row[C.cS]||'0'), 
                    carCost:parseCurrency(row[C.car]||'0'), publicTransitCost:parseCurrency(row[C.pub]||'0'),
                    lodgingEtcCost:parseCurrency(row[C.lod]||'0'), incidentalCostTotal:parseCurrency(row[C.total]||'0'), 
                    isRefundableRaw:row[C.rR]||'N/A', content:row[C.cnt]||'ë‚´ìš©ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 
                    purpose:row[C.prp]||'ëª©ì ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', expectedEffect:row[C.eff]||'ê¸°ëŒ€íš¨ê³¼ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 
                    summary:row[C.sum]||'êµìœ¡ ìš”ì•½ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', linkage:row[C.lkg]||'ì—…ë¬´ì ìš© ê³„íšì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 
                    difficulty:row[C.dif]||'ì—…ë¬´ì ìš© ì• ë¡œì‚¬í•­ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 
                    implementationDate:row[C.iD]||'ì˜ˆìƒ ì—…ë¬´ì ìš© ë°œí˜„ì‹œì ', email:erp?.email || 'ì´ë©”ì¼ ë¯¸ë“±ë¡',
                    dateSort:parseDateSort(row[C.p]), goalHours: 0
                };
            }).filter(item => item.dept === CURRENT_DEPARTMENT || item.dept === 'ê¸°íƒ€');
        }

        async function fetchData(range,sourceName,erpMap){
            const URL=`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
            try{
                if(!API_KEY||!SPREADSHEET_ID){throw new Error(`API í‚¤ ë˜ëŠ” ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. [${sourceName}]`)}
                const response=await fetch(URL);
                if(!response.ok){const errorJson = await response.json();throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}. ì‚¬ìœ : ${errorJson.error?.message || 'ì•Œ ìˆ˜ ì—†ìŒ'}. [${sourceName}]`)}
                const data=await response.json();
                return processSheetData(data.values||[],sourceName,erpMap);
            }catch(error){
                console.error(`Google Sheets ì—°ë™ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (${sourceName}):`,error);
                document.getElementById('loadingMessage').textContent=`ğŸš¨ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${error.message}`;
                return[];
            }
        }

        async function fetchERPData(){
            const MOCK_ERP_DATA_LOCAL={'202320458':{dept:'FSì‚¬ì—…ë³¸ë¶€',email:'jdh@company.com'},'202120458':{dept:'ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€',email:'jdh2@company.com'},'202020458':{dept:'FSì‚¬ì—…ë³¸ë¶€',email:'ldh@company.com'},'202220458':{dept:'FPCBì‚¬ì—…ë³¸ë¶€',email:'pdh@company.com'},'202420458':{dept:'ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€',email:'kdh@company.com'},'201920458':{dept:'FPCBì‚¬ì—…ë³¸ë¶€',email:'kdh2@company.com'},'201820458':{dept:'ê²½ì˜ì§€ì›ë³¸ë¶€',email:'mdh@company.com'},'201710001':{dept:'FPCBì‚¬ì—…ë³¸ë¶€',email:'test1@comp.com'},'201710002':{dept:'FPCBì‚¬ì—…ë³¸ë¶€',email:'test2@comp.com'},'201710003':{dept:'FPCBì‚¬ì—…ë³¸ë¶€',email:'test3@comp.com'},'201710004':{dept:'FPCBì‚¬ì—…ë³¸ë¶€',email:'test4@comp.com'},'201710005':{dept:'FPCBì‚¬ì—…ë³¸ë¶€',email:'test5@comp.com'},};
            const URL=`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(ERP_RANGE)}?key=${API_KEY}`;
            try{
                if(!API_KEY||!SPREADSHEET_ID){throw new Error(`API í‚¤ ë˜ëŠ” ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. [ERP]`)}
                const response=await fetch(URL);
                if(!response.ok){throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}. ERP ì‹œíŠ¸ ë¡œë”© ì‹¤íŒ¨. [ERP]`)}
                return processERPData((await response.json()).values||[]);
            }catch(error){
                console.error(`Google Sheets ì—°ë™ ì¤‘ ì˜¤ë¥˜ ë°œìƒ (ERP):`,error);
                if(error.message.includes("API í‚¤ ë˜ëŠ” ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.")){return MOCK_ERP_DATA_LOCAL}
                else{return{}}
            }
        }

        // --- Rendering & Calculation Functions ---

        function calculateDashboardMetrics(data){
            const uniqueEmployees={};
            let extCost=0, aoCost=0, incCost=0;
            data.forEach(item=>{
                const id = item.employeeId;
                if(!uniqueEmployees[id]){uniqueEmployees[id] = { externalHours: 0, goalHours: item.goalHours || 0 };}
                if(item.source==='ì‚¬ì™¸êµìœ¡'){
                    uniqueEmployees[id].externalHours+=item.actualHours;
                    extCost+=item.actualCost;
                    incCost+=item.incidentalCostTotal;
                }else if(item.source==='ìƒì‹œí•™ìŠµì§€ì›'){
                    aoCost+=item.actualCost;
                    incCost+=item.incidentalCostTotal;
                }
            });
            const empList=Object.values(uniqueEmployees);
            const totalEmp=empList.length;
            let totalHours=0, totalGoal=0;
            empList.forEach(e => {totalHours+=e.externalHours;totalGoal+=e.goalHours});
            const rate=totalGoal>0?((totalHours/totalGoal)*100).toFixed(1)+'%':'N/A';
            return{
                totalEmployees: totalEmp, targetAchievementRate: rate,
                externalCostTotal: extCost, alwaysOnCostTotal: aoCost, incidentalCostTotal: incCost,
                avgExternalCostPerPerson: totalEmp>0?extCost/totalEmp:0,    
                avgAlwaysOnCostPerPerson: totalEmp>0?aoCost/totalEmp:0
            };
        }

        // KPI ì¹´ë“œê°€ ëª¨ë‘ ì œê±°ë˜ì—ˆìœ¼ë¯€ë¡œ, renderDashboardëŠ” KPI ê°’ë§Œ ê³„ì‚°í•  ë¿ DOM ì—…ë°ì´íŠ¸ëŠ” í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        function renderDashboard(metrics){
            // ì—°ê°„ êµìœ¡ ëª©í‘œ ìƒì„¸ì˜ KPI ê°’ì€ ê³ ì • ì„¹ì…˜ì— ì§ì ‘ í‘œì‹œë˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì—…ë°ì´íŠ¸í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
            // ëŒ€ì‹ , ì—°ê°„ ëª©í‘œ ìƒì„¸ ì„¹ì…˜ì˜ ì œëª©ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
            const totalEmployees = metrics.totalEmployees;
            const achievementRate = metrics.targetAchievementRate;

            const totalEmployeesEl = document.getElementById('fixed-total-employees');
            if (totalEmployeesEl) totalEmployeesEl.textContent = `ì´ì› (${totalEmployees}ëª…)`;

            const achievementRateEl = document.getElementById('fixed-achievement-rate');
            if (achievementRateEl) achievementRateEl.textContent = achievementRate;
        }

        function getAggregatedEmployeeData(data){
            const aggregated={};
            data.forEach(item=>{
                if(!aggregated[item.employeeId]){
                    aggregated[item.employeeId]={
                        employeeId:item.employeeId,employeeName:item.employeeName,dept:item.dept,
                        email:item.email,totalHours:0,externalHours:0,items:[],
                        team: item.team || 'N/A'
                    };
                }
                aggregated[item.employeeId].totalHours+=item.actualHours;
                if(item.source==='ì‚¬ì™¸êµìœ¡'){aggregated[item.employeeId].externalHours+=item.actualHours}
                aggregated[item.employeeId].items.push({subject:item.subject,actualHours:item.actualHours,source:item.source,dateSort:parseDateSort(item.period),period:item.period}); 
            });
            return Object.values(aggregated);
        }

        function renderMandatoryComplianceList(filteredData){
            const aggregatedData=getAggregatedEmployeeData(filteredData);
            const nonCompliant=aggregatedData.filter(e=>e.externalHours<MANDATORY_MINIMUM_HOURS);
            
            // Group non-compliant employees by team
            const nonCompliantByTeam = {};
            nonCompliant.forEach(employee => {
                const team = employee.team || 'ë¯¸ì •';
                if (!nonCompliantByTeam[team]) {
                    nonCompliantByTeam[team] = [];
                }
                nonCompliantByTeam[team].push(employee);
            });

            const listContainer=document.getElementById('mandatoryComplianceList');
            const mandatoryCountEl = document.getElementById('mandatoryCount');
            if (mandatoryCountEl) mandatoryCountEl.textContent = nonCompliant.length;
            if (!listContainer) return;

            if(nonCompliant.length===0){
                listContainer.innerHTML='<p class="text-center text-gray-500 p-4 w-full">í•„í„° ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ë¯¸ì™„ë£Œ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            // Determine teams to display and sort them
            const teamsToDisplay = [...ALL_TEAMS, 'ë¯¸ì •', 'ê¸°íƒ€']
                .filter(team => nonCompliantByTeam[team] && nonCompliantByTeam[team].length > 0);

            const teamSectionsHtml = teamsToDisplay.map(team => {
                const employees = nonCompliantByTeam[team].sort((a, b) => a.externalHours - b.externalHours);
                
                // Use team-specific color hints
                const hex = TEAM_CHART_COLORS[team] || 'rgb(107, 114, 128)'; // Fallback to grey
                const bg = hex.replace('rgb','rgba').replace(')','), 0.1)');
                const text = hex; 
                const border = text.replace('rgb','rgba').replace(')','), 0.3)');
                const sectionBorder = text.replace('rgb','rgba').replace(')','), 0.4)');
                const divider = text.replace('rgb','rgba').replace(')','), 0.2)');
                
                const tags = employees.map(e=>`
                    <div class="px-2 py-1 text-xs rounded-full border flex items-center space-x-1" style="border-color:${border} !important;color:${text};" title="${e.employeeId} / ${e.email}">
                        <span class="font-bold">${e.employeeName}</span>
                        <span class="text-gray-600 font-medium ml-0">(${e.externalHours.toFixed(1)}h)</span>
                        <span class="text-gray-500 text-[10px] truncate ml-1">${e.email}</span>
                    </div>
                `).join('');

                return `
                    <div class="w-full p-3 rounded-lg shadow-sm border mb-4" style="border-color:${sectionBorder};background-color:${bg};">
                        <h4 class="text-sm font-extrabold mb-2 pb-1 border-b" style="color:${text};border-color:${divider}">
                            ${team} (${employees.length}ëª…)
                        </h4>
                        <div class="flex flex-wrap gap-1.5 max-h-32 overflow-y-auto">
                            ${tags}
                        </div>
                    </div>
                `;
            }).join('');

            listContainer.innerHTML = `<div class="p-2 w-full">${teamSectionsHtml}</div>`;
        }


        function getTopTopicsHelper(data, topN = 5) {
            const topicCounts = {};
            data.forEach(item => {
                const subject = item.subject || 'ë¯¸ì •ì˜';
                const keywords = subject.split(/[\s\/\-\(\)]+/)
                                         .filter(w => w.length > 1 && !['êµìœ¡', 'ê³¼ì •', 'ê¸°ì´ˆ', 'ì‹¤ë¬´', 'ì„¸ë¯¸ë‚˜', 'ë°'].includes(w));
                if (keywords.length === 0) { keywords.push(subject.split(' ')[0].replace(/[^ê°€-í£A-Za-z]/g, '')); }
                keywords.forEach(keyword => {
                    const cleanKeyword = keyword.trim();
                    if (cleanKeyword) { topicCounts[cleanKeyword] = (topicCounts[cleanKeyword] || 0) + 1; }
                });
            });
            return Object.entries(topicCounts).sort(([, a], [, b]) => b - a).slice(0, topN).map(([topic]) => `#${topic}`);
        }

        function getTopicsByTeam(data, teams) {
            const teamDataMap = {};
            const teamTopics = {};
            data.forEach(item => {
                const team = item.team || 'ë¯¸ì •';
                if (!teamDataMap[team]) { teamDataMap[team] = []; }
                teamDataMap[team].push(item);
            });
            const allRelevantTeams = [...new Set([...teams, ...Object.keys(teamDataMap)].filter(t => t !== 'N/A'))];
            allRelevantTeams.forEach(team => {
                const teamData = teamDataMap[team] || [];
                teamTopics[team] = getTopTopicsHelper(teamData, 3);
            });
            return teamTopics;
        }

        function renderTopHashtags(data) {
            const container = document.getElementById('topHashtagsContainer');
            if (!container) return;
            const overallTopHashtags = getTopTopicsHelper(data, 5); 
            const teamTopics = getTopicsByTeam(data, ALL_TEAMS);
            
            let overallHtml = overallTopHashtags.length===0?'<span class="text-sm text-gray-500">ê´€ì‹¬ì‚¬ ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.</span>':
                overallTopHashtags.map(tag => `<span class="inline-block bg-green-100 text-green-700 text-sm font-bold px-3 py-1 rounded-full shadow-md transition hover:bg-green-200">${tag}</span>`).join('');

            const teamHtmlCompact = Object.entries(teamTopics).map(([teamName, tags]) => {
                const teamTagsHtml = tags.length > 0?tags.map(tag => `<span class="text-indigo-600 font-medium">${tag}</span>`).join(' '):`<span class="text-gray-500">ê´€ì‹¬ì‚¬ ì—†ìŒ</span>`;
                return `
                    <div class="whitespace-nowrap text-xs bg-white p-2 rounded-lg border border-gray-100 shadow-sm flex-shrink-0">
                        <span class="font-bold text-gray-700 mr-1">${teamName}</span>
                        ${teamTagsHtml}
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <div class="mb-4">
                    <h3 class="text-lg font-bold text-gray-800 mb-2">${CURRENT_DEPARTMENT} ì£¼ìš” ê´€ì‹¬ì‚¬</h3>
                    <div class="flex flex-wrap gap-2 p-3 bg-green-50 border border-green-200 rounded-lg">${overallHtml}</div>
                </div>
                <div class="mt-6">
                    <div class="flex flex-wrap gap-2 p-3 bg-gray-100 rounded-lg border border-gray-200">${teamHtmlCompact}</div>
                </div>
            `;
        }

        function renderAchievementChart(data){
            const ctx = document.getElementById('deptAchievementBarChart');
            const infoElement = document.getElementById('achievementChartInfoTextInline');
            const goalListContainer = document.getElementById('achievementGoalsListContainer'); // ëª©í‘œ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ
            if (!ctx || !infoElement || !goalListContainer) return;

            const teamStats = {};
            const participatingEmployees = new Set();
            
            data.forEach(item => {
                const team = item.team || 'ë¯¸ì •';
                const id = item.employeeId;
                const hours = item.source === 'ì‚¬ì™¸êµìœ¡' ? item.actualHours : 0;
                const goal = item.goalHours || 0; 
                if (!teamStats[team]) {teamStats[team] = { totalActualHours: 0, totalGoalHours: 0, uniqueEmployees: new Set() };}
                teamStats[team].totalActualHours += hours;
                participatingEmployees.add(id);
                if (!teamStats[team].uniqueEmployees.has(id)) {
                    teamStats[team].totalGoalHours += goal; 
                    teamStats[team].uniqueEmployees.add(id);
                }
            });

            // ë°” ì°¨íŠ¸ ë Œë”ë§ì„ ìœ„í•œ ë°ì´í„° ì¤€ë¹„
            const teamsToDisplay = [...ALL_TEAMS];
            if (teamStats['ë¯¸ì •'] && teamStats['ë¯¸ì •'].uniqueEmployees.size > 0) teamsToDisplay.push('ë¯¸ì •');
            if (teamStats['ê¸°íƒ€'] && teamStats['ê¸°íƒ€'].uniqueEmployees.size > 0) teamsToDisplay.push('ê¸°íƒ€');

            let totalGoalHoursAll = 0; 
            let totalActualHoursAll = 0; 
            
            const sortedDisplayData = teamsToDisplay.map(team => {
                const stats = teamStats[team] || { totalActualHours: 0, totalGoalHours: 0, uniqueEmployees: new Set() };
                const goal = stats.totalGoalHours;
                const hours = stats.totalActualHours;
                if (stats.uniqueEmployees.size > 0) { 
                    totalGoalHoursAll += goal; 
                    totalActualHoursAll += hours; 
                }
                let rate = 0;
                if (goal > 0) { rate = parseFloat(((hours / goal) * 100).toFixed(1)); }
                return {label: team, rate: rate, hours: hours, goal: goal}; // íŒ€ë³„ ì‹¤ì  ë° ëª©í‘œ ì¶”ê°€ ë°˜í™˜
            }).sort((a, b) => b.rate - a.rate);

            const labels = sortedDisplayData.map(d => d.label);
            const rates = sortedDisplayData.map(d => d.rate);
            const baseColor = DEPARTMENT_COLORS[CURRENT_DEPARTMENT] || 'rgb(16, 185, 129)';
            const colors = sortedDisplayData.map((d, i) => baseColor.replace(')', `, ${0.5 + (i / sortedDisplayData.length) * 0.5})`).replace('rgb', 'rgba'));

            if(achievementChartInstance) achievementChartInstance.destroy();
            
            // í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸: ëª©í‘œ ì´í•©ê³¼ ì‹¤ì œ ì¸ì • ì‹œê°„ ì´í•© í‘œì‹œ
            infoElement.textContent = `íŒ€ë³„ í˜„í™©: FPCBì‚¬ì—…ë³¸ë¶€ (${participatingEmployees.size}ëª…) - ê°œì¸ ëª©í‘œ ì´í•© (${totalGoalHoursAll.toFixed(1)} ì‹œê°„) / ì‹¤ì œ ì¸ì • ì‹œê°„ (${totalActualHoursAll.toFixed(1)} ì‹œê°„) ê¸°ì¤€ ë‹¬ì„±ìœ¨ì…ë‹ˆë‹¤. (ì‚¬ì™¸êµìœ¡ë§Œ ë°˜ì˜)`;
            
            achievementChartInstance = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {labels: labels, datasets: [{label: 'ëª©í‘œ ë‹¬ì„±ìœ¨ (%)',data: rates,backgroundColor: colors,borderColor: baseColor.replace(')', ', 0.8)').replace('rgb', 'rgba'),borderWidth: 1,maxBarThickness: 50}]},
                options: {
                    responsive: true, maintainAspectRatio: false, indexAxis: 'x', // ì¸ë±ìŠ¤ ì¶•ì„ 'x'ë¡œ ë³€ê²½ (ì„¸ë¡œ ë§‰ëŒ€)
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 150,
                            title: { display: true, text: 'ë‹¬ì„±ìœ¨ (%)' } // Yì¶•ì— ë‹¬ì„±ìœ¨ í‘œì‹œ
                        },
                        x: {
                            grid: { display: false } // Xì¶• (íŒ€ ë¼ë²¨) ê·¸ë¦¬ë“œ ì œê±°
                        }
                    },
                    plugins: {legend: { display: false },title: { display: false }}
                }
            });

            // ----------------------------------------------------
            // íŒ€ë³„ êµ¬ì²´ì ì¸ êµìœ¡ ëª©í‘œ í•­ëª© ë Œë”ë§ ì¶”ê°€ (ë¯¸ì •/ê¸°íƒ€ ì œì™¸)
            // ----------------------------------------------------
            let goalsHtml = '';
            
            // ë¯¸ì •/ê¸°íƒ€ë¥¼ ì œì™¸í•œ ëª…ì‹œëœ ëª¨ë“  íŒ€ ëª©ë¡ë§Œ ì‚¬ìš©
            const allGoalTeams = [...ALL_TEAMS];

            allGoalTeams.forEach(team => {
                // teamDataì—ì„œ í•´ë‹¹ íŒ€ì˜ ì‹¤ì  ì •ë³´ ì°¾ê¸°
                const teamData = sortedDisplayData.find(d => d.label === team);
                const stats = teamStats[team] || { totalActualHours: 0, totalGoalHours: 0, uniqueEmployees: new Set() };

                const employeeCount = stats.uniqueEmployees.size;
                const goals = MOCK_TEAM_GOAL_DETAILS[team] || [{name: 'ëª©í‘œ ë¯¸ì„¤ì •', hours: 0}];
                
                const goalItems = goals.map((goal, index) => `
                    <li class="flex justify-between text-sm text-gray-700 pt-1">
                        <span class="font-medium">${index + 1}. ${goal.name}</span>
                        <span class="font-bold text-blue-600">${goal.hours} ì‹œê°„</span>
                    </li>
                `).join('');

                // í•´ë‹¹ íŒ€ì˜ ì‹¤ì œ ì‹¤ì  ì‹œê°„ ê°€ì ¸ì˜¤ê¸° (ë°ì´í„°ê°€ ì—†ìœ¼ë©´ 0.0)
                const actualHours = teamData ? teamData.hours.toFixed(1) : (stats.totalActualHours.toFixed(1) || '0.0');

                goalsHtml += `
                    <div class="p-4 bg-white rounded-lg shadow-sm border border-blue-200 flex-shrink-0 min-w-[280px]">
                        <h4 class="text-lg font-extrabold text-gray-800 mb-2 border-b pb-1 flex justify-between items-center">
                            <span>${team} ëª©í‘œ (${employeeCount}ëª…)</span>
                            <span class="text-sm font-medium text-gray-600">ì‹¤ì : ${actualHours}h</span>
                        </h4>
                        <ul class="space-y-1">${goalItems}</ul>
                    </div>
                `;
            });
            
            goalListContainer.innerHTML = `
                <h3 class="text-lg font-bold text-gray-800 mb-3 border-b pb-2">íŒ€ë³„ êµ¬ì²´ ëª©í‘œ ë‚´ì—­ (ì˜ˆì‹œ)</h3>
                <div class="flex gap-4 pt-2 overflow-x-auto pb-4">
                    ${goalsHtml}
                </div>
            `;
        }

        
        function renderEmployeeListDetail(data) {
            const fixedContainer = document.getElementById('employeeChartFixedContainer');
            const chartCtx = fixedContainer.querySelector('#teamHeadcountPieChart');
            const summaryContainer = fixedContainer.querySelector('#teamHeadcountSummary');
            
            if (!chartCtx || !summaryContainer) return;

            const aggregatedData = getAggregatedEmployeeData(data);
            const teamStats = {};
            const uniqueEmployeeIds = new Set();
            const teamEmployeeMap = {}; 

            aggregatedData.forEach(e => {
                if (!uniqueEmployeeIds.has(e.employeeId)) {
                    uniqueEmployeeIds.add(e.employeeId);
                    const team = e.team || 'ë¯¸ì •';
                    if (!teamStats[team]) { teamStats[team] = { count: 0, members: [] }; }
                    teamStats[team].count++;
                    teamStats[team].members.push(e.employeeName + ' (' + e.employeeId + ')'); 
                }
            });

            const teamsToDisplay = [...ALL_TEAMS];
            ['ë¯¸ì •', 'ê¸°íƒ€'].forEach(team => {
                if (teamStats[team] && teamStats[team].count > 0 || !ALL_TEAMS.includes(team)) { teamsToDisplay.push(team); }
            });
            const finalTeamsToDisplay = [...new Set(teamsToDisplay)];

            const chartLabels = [], chartData = [], chartBgColors = [];
            finalTeamsToDisplay.forEach(team => {
                const stat = teamStats[team] || { count: 0, members: [] };
                const color = TEAM_CHART_COLORS[team] || 'rgb(107, 114, 128)';
                chartLabels.push(team); 
                chartData.push(stat.count); 
                chartBgColors.push(color); 
                teamEmployeeMap[team] = { count: stat.count, members: stat.members };
            });

            summaryContainer.innerHTML = EMPLOYEE_SUMMARY_PLACEHOLDER; 
            
            const renderHoveredTeamMembers = (team, map, container) => {
                const data = map[team];
                if (!data || data.count === 0) {
                    container.innerHTML = `<div class="p-3 bg-indigo-100 rounded-xl border border-indigo-300 custom-scroll max-h-64"><h4 class="text-sm font-bold text-indigo-800 mb-2">${team} (ì´ 0ëª…)</h4><p class="text-xs text-gray-500">ì†Œì† ì¸ì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p></div>`;
                    return;
                }
                const membersHtml = data.members.map(m => `<li class="text-xs text-gray-700">${m}</li>`).join('');
                container.innerHTML = `<div class="p-3 bg-indigo-100 rounded-xl border border-indigo-300 custom-scroll max-h-64"><h4 class="text-sm font-bold text-indigo-800 mb-2">${team} (ì´ ${data.count}ëª…)</h4><ul class="list-disc list-inside space-y-1 pr-2">${membersHtml}</ul></div>`;
            };
            
            let lastHoveredTeam = null;

            if (employeeChartInstance) employeeChartInstance.destroy();

            employeeChartInstance = new Chart(chartCtx.getContext('2d'), {
                type: 'pie',
                data: {labels: chartLabels, datasets: [{data: chartData, backgroundColor: chartBgColors, hoverOffset: 8, borderWidth: 1, borderColor: '#ffffff'}]},
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onHover: (e, elems, chart) => {
                        if (elems.length) {
                            const team = chart.data.labels[elems[0].index];
                            if (lastHoveredTeam !== team) {
                                renderHoveredTeamMembers(team, teamEmployeeMap, summaryContainer);
                                lastHoveredTeam = team;
                            }
                        } else {
                            if (lastHoveredTeam !== null) {
                                summaryContainer.innerHTML = EMPLOYEE_SUMMARY_PLACEHOLDER;
                                lastHoveredTeam = null;
                            }
                        }
                    },
                    plugins: {
                        legend: {position: 'right', labels: {font: {family: 'Inter, Noto Sans KR'}}},
                        title: {display: true, text: 'íŒ€ë³„ ì¸ì› ë¶„í¬', font: {family: 'Inter, Noto Sans KR', size: 16, weight: 'bold'}},
                        tooltip: {
                            callbacks: {
                                title: (items) => `${items[0].label} (ì´ ${teamEmployeeMap[items[0].label]?.count || 0}ëª…)`,
                                label: (item) => {
                                    const members = teamEmployeeMap[item.label]?.members || [];
                                    const displayMembers = members.slice(0, 5).join(', ');
                                    let label = `ì†Œì†: ${displayMembers}`;
                                    if (members.length > 5) { label += ` ì™¸ ${members.length - 5}ëª…`; } 
                                    else if (members.length === 0) { label = `ì†Œì† ì¸ì› ì—†ìŒ`; }
                                    return label;
                                }
                            },
                            bodyFont: {family: 'Inter, Noto Sans KR'}, titleFont: {family: 'Inter, Noto Sans KR'}
                        }
                    }
                }
            });
        }
        
        function clearFilters(){
            ['filterSubject','filterEmployeeName','filterPosition','filterStatus'].forEach(id=>{document.getElementById(id).value=''});
        }

        function renderTeamButtons() {
            const container = document.getElementById('teamButtonContainer');
            if (!container) return;
            container.querySelectorAll('.team-btn').forEach(button => {
                const teamName = button.dataset.team;
                button.className = `team-btn px-4 py-1.5 rounded-full text-xs transition shadow-md whitespace-nowrap ${
                    teamName === currentTeam ? 'bg-blue-600 text-white hover:bg-blue-700 shadow-lg font-bold' : 'bg-gray-200 text-gray-700 hover:bg-gray-300 font-medium'
                }`;
            });
        }
        
        function filterByTeam(data, team) {
            return team === 'ì „ì²´' ? data : data.filter(item => item.team === team);
        }

        function handleTeamFilter(event) {
            const newTeam = event.currentTarget.dataset.team;
            if (newTeam !== 'ì „ì²´') { window.location.href = QUALITY_TEAM_EXTERNAL_URL; return; }
            if (currentTeam === newTeam) return; 
            currentTeam = newTeam;
            renderTeamButtons(); 
            const filtered = filterByTeam(fullDeptData, currentTeam);
            renderMandatoryComplianceList(filtered);
            renderEducationList(applyListFilters(filtered));
        }
        window.handleTeamFilter = handleTeamFilter;


        function renderEducationList(data){
            const listContainer=document.getElementById('educationList');
            const resultCount=document.getElementById('resultCount');
            if (!listContainer) return; 
            if (resultCount) resultCount.textContent=data.length; 
            if(data.length===0){listContainer.innerHTML='<p class="text-center text-gray-500 p-8">ê²€ìƒ‰ ì¡°ê±´ì— ë§ëŠ” êµìœ¡ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';return}
            data.sort((a,b)=>b.dateSort-a.dateSort); 

            listContainer.innerHTML=data.map(item=>{
                const employeeInfo=`<span class="text-gray-500 text-xs mr-3">${item.employeeId}</span> <span class="font-semibold text-gray-700">${item.employeeName}</span> / <span class="text-blue-600 font-bold">${item.team}</span>`; 
                const itemJson = JSON.stringify(item).replace(/"/g, '&quot;');
                const statusHtml = item.isCompleted?'<span class="text-green-600 font-bold">ì™„ë£Œ</span>':'<span class="text-red-500 font-medium">ì§„í–‰ì¤‘</span>';
                const sourceHtml = item.source==='ì‚¬ì™¸êµìœ¡'?'ì‚¬ì™¸':'ìƒì‹œ';
                const refundHtml = item.isRefundableRaw==='O'?'<span class="font-bold text-green-700">O</span>':(item.isRefundableRaw==='X'?'<span class="text-gray-500">X</span>':'<span class="text-gray-500">N/A</span>');

                return`
                    <div class="education-item bg-white p-4 border border-blue-100 rounded-lg shadow-sm hover:shadow-md transition duration-200 cursor-pointer" onclick="openDetailModal(${itemJson})">
                        <div class="flex flex-col justify-start border-b pb-2 mb-2">
                            <div class="flex justify-between items-start">
                                <h3 class="text-lg font-bold text-gray-900">${item.subject}</h3>
                                <div class="flex items-center space-x-2">
                                    <span class="text-xs font-semibold px-2 py-0.5 bg-green-100 text-green-800 rounded-full">${item.host}</span>
                                    <svg class="w-5 h-4 text-gray-500 transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4m-6 3a4 4 0 100-8 4 4 0 000 8zm-2-2h4M7 7h.01" /></svg>
                                </div>
                            </div>
                            <div class="mt-1 text-sm">${employeeInfo}</div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-sm text-gray-700 p-2 bg-gray-50 rounded-md">
                            <p class="flex items-center"><span class="w-20 font-semibold text-gray-600">ê¸°ê°„:</span> <span class="flex-1">${item.period}</span></p>
                            <p class="flex items-center"><span class="w-20 font-semibold text-gray-600">ìƒíƒœ:</span> <span class="flex-1">${statusHtml}</span></p>
                            <p class="flex items-center"><span class="w-20 font-semibold text-gray-600">í˜•íƒœ:</span> <span class="flex-1">${item.type} (${sourceHtml})</span></p>
                            <p class="flex items-center"><span class="w-20 font-semibold text-gray-600">ì¸ì •ì‹œê°„:</span> <span class="flex-1 text-indigo-600">${item.actualHours.toFixed(1)} ì‹œê°„</span></p>
                            <p class="flex items-center"><span class="w-20 font-semibold text-gray-600">ë¹„ìš©:</span> <span class="flex-1 text-gray-800">${formatCurrency(item.actualCost)}</span></p>
                            <p class="flex items-center"><span class="w-20 font-semibold text-gray-600">í™˜ê¸‰ì—¬ë¶€:</span> <span class="flex-1">${refundHtml}</span></p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function applyListFilters(data) {
            const subject = document.getElementById('filterSubject')?.value.trim().toLowerCase() || '';
            const employee = document.getElementById('filterEmployeeName')?.value.trim().toLowerCase() || '';
            const position = document.getElementById('filterPosition')?.value || '';
            const status = document.getElementById('filterStatus')?.value || '';
            
            let filteredData = [...data]; 

            if(subject){filteredData=filteredData.filter(item=>item.subject.toLowerCase().includes(subject))}
            if(employee){filteredData=filteredData.filter(item=>item.employeeId.toLowerCase().includes(employee)||item.employeeName.toLowerCase().includes(employee))}
            if(position){filteredData=filteredData.filter(item=>item.position===position)}
            if(status==='COMPLETED'){filteredData=filteredData.filter(item=>item.isCompleted===true)}
            else if(status==='IN_PROGRESS'){filteredData=filteredData.filter(item=>item.isCompleted===false)}
            
            return filteredData.sort((a,b)=>b.dateSort-a.dateSort);
        }

        function renderInitialKPIs(data){
            const initialDeptData = [...allEducationData,...allAlwaysOnData].filter(item=>item.dept===CURRENT_DEPARTMENT);
            const metrics=calculateDashboardMetrics(initialDeptData);
            renderDashboard(metrics,initialDeptData);
            return initialDeptData; 
        }
        
        function updateAllListViews(fullData, teamFilter) {
            const filtered = filterByTeam(fullData, teamFilter);
            renderTopHashtags(fullData);
            renderMandatoryComplianceList(filtered);
            renderEducationList(applyListFilters(filtered));
        }

        // Modal Open Function (Updated for brevity)
        function openDetailModal(item) {
            const modal = document.getElementById('educationModal');
            const modalContent = document.getElementById('modalContent');
            
            const renderDetailItem = (title, content, checkCompleted) => {
                if (checkCompleted && !item.isCompleted) return '';
                const display = content && content.trim() !== 'N/A' && content.trim() !== '' ? content : 'ë‚´ìš© ë¯¸ë“±ë¡';
                const color = display === 'ë‚´ìš© ë¯¸ë“±ë¡' ? 'text-gray-500' : 'text-gray-700';
                return `<div class="mb-4 p-3 bg-gray-50 rounded-lg"><h4 class="font-bold text-gray-800 mb-1 border-b pb-1 flex items-center"><svg class="w-4 h-4 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2m-9 0V3h4v2m-4 0h4" /></svg>${title}</h4><p class="text-sm ${color} whitespace-pre-wrap">${display}</p></div>`;
            };
            
            const statusText = item.isCompleted ? '<span class="text-green-600 font-bold">ì™„ë£Œ</span>' : '<span class="text-red-500 font-medium">ì§„í–‰ì¤‘</span>';
            const refundStatus = item.isRefundableRaw === 'O' ? '<span class="font-bold text-green-700">O</span>' : (item.isRefundableRaw === 'X' ? '<span class="text-gray-500">X</span>' : '<span class="text-gray-500">N/A</span>');
            const employeeInfo = `<span class="text-gray-500 text-sm">${item.employeeId}</span> / <span class="font-semibold text-gray-700">${item.employeeName}</span> / <span class="text-blue-600 font-bold">${item.team}</span>`;
            
            let detailHtml = renderDetailItem('êµìœ¡ ë‚´ìš©', item.content, false);
            detailHtml += renderDetailItem('êµìœ¡ ëª©ì ', item.purpose, false);
            detailHtml += renderDetailItem('ê¸°ëŒ€ íš¨ê³¼', item.expectedEffect, false);
            detailHtml += renderDetailItem('êµìœ¡ ìš”ì•½', item.summary, true);
            detailHtml += renderDetailItem('ì—…ë¬´ì ìš© ê³„íš', item.linkage, true);
            detailHtml += renderDetailItem('ì—…ë¬´ì ìš© ì• ë¡œì‚¬í•­', item.difficulty, true);
            detailHtml += renderDetailItem('ì˜ˆìƒ ì—…ë¬´ì ìš© ë°œí˜„ì‹œì ', item.implementationDate, true);

            modalContent.innerHTML = `
                <div class="border-b pb-4 mb-4"><h2 class="text-2xl font-extrabold text-gray-900 mb-1">${item.subject}</h2><p class="text-sm text-gray-600">${employeeInfo} (${item.dept})</p></div>
                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 text-sm mb-6 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <p><span class="font-semibold text-gray-700">ê¸°ê°„:</span> ${item.period}</p><p><span class="font-semibold text-gray-700">ìƒíƒœ:</span> ${statusText}</p>
                    <p><span class="font-semibold text-gray-700">ì£¼ê´€:</span> ${item.host}</p><p><span class="font-semibold text-gray-700">í˜•íƒœ:</span> ${item.type} (${item.source})</p>
                    <p><span class="font-semibold text-gray-700">ì¸ì •ì‹œê°„:</span> <span class="text-indigo-600">${item.actualHours.toFixed(1)} ì‹œê°„</span></p>
                    <p><span class="font-semibold text-gray-700">ë¹„ìš©:</span> ${formatCurrency(item.actualCost)}</p>
                    <p><span class="font-semibold text-gray-700">ë¶€ëŒ€ë¹„ìš©:</span> ${formatCurrency(item.incidentalCostTotal)}</p>
                    <p><span class="font-semibold text-gray-700">í™˜ê¸‰ì—¬ë¶€:</span> ${refundStatus}</p>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">ìƒì„¸ ë³´ê³ ì„œ í•­ëª©</h3>
                <div class="max-h-96 custom-scroll pr-2">${detailHtml}</div>
            `;
            
            modal.classList.remove('hidden');
        }
        window.openDetailModal = openDetailModal;


        document.addEventListener('DOMContentLoaded',async()=>{
            try{
                const loadingMessage=document.getElementById('loadingMessage');
                if (loadingMessage) loadingMessage.textContent="Google Sheet ë°ì´í„° ë¡œë”© ì¤‘...";
                
                const erpMap=await fetchERPData();
                allEducationData=await fetchData(EXTERNAL_RANGE,'ì‚¬ì™¸êµìœ¡',erpMap);
                allAlwaysOnData=await fetchData(ALWAYS_ON_RANGE,'ìƒì‹œí•™ìŠµì§€ì›',erpMap); 
                
                let combinedDeptData = [...allEducationData, ...allAlwaysOnData].filter(item => item.dept === CURRENT_DEPARTMENT);
                fullDeptData = mockTeamAssignment(combinedDeptData);

                renderInitialKPIs(fullDeptData); 
                renderEmployeeListDetail(fullDeptData);
                renderAchievementChart(fullDeptData); // ì—°ê°„ ëª©í‘œ ì°¨íŠ¸ ì¦‰ì‹œ ë¡œë“œ
                
                if(loadingMessage && loadingMessage.textContent==="Google Sheet ë°ì´í„° ë¡œë”© ì¤‘..."){loadingMessage.remove()}
                
                renderTeamButtons(); 
                updateAllListViews(fullDeptData, currentTeam); 

            }catch(error){
                console.error("Failed to load education data (outside fetch):",error);
            }
            
            document.getElementById('applyFilters')?.addEventListener('click',()=>{
                const filtered=filterByTeam(fullDeptData,currentTeam);
                renderEducationList(applyListFilters(filtered));
            });

            document.getElementById('clearFilters')?.addEventListener('click',()=>{
                clearFilters(); 
                const filtered=filterByTeam(fullDeptData,currentTeam);
                renderEducationList(applyListFilters(filtered));
            });
            
            document.getElementById('teamButtonContainer')?.querySelectorAll('.team-btn').forEach(btn => {
                btn.addEventListener('click', handleTeamFilter);
            });
        });
    </script>

    <!-- HTML Markup Start -->
    <div id="app" class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl p-4 sm:p-8">
        <div class="flex justify-between items-start mb-6 border-b pb-3">
            <h1 class="text-3xl font-bold text-gray-800">êµìœ¡ í˜„í™© ëŒ€ì‹œë³´ë“œ - FPCBì‚¬ì—…ë³¸ë¶€</h1>
        </div>
        
        <div class="mb-6 flex flex-wrap gap-3">
            <!-- FPCB ì‚¬ì—…ë³¸ë¶€ í•˜ìœ„ íŒ€ ëª©ë¡ -->
            <div id="teamButtonContainer" class="grid grid-cols-3 sm:grid-cols-4 gap-2 w-full">
                <button data-team="ì „ì²´" class="team-btn">ì „ì²´</button> 
                <button data-team="í’ˆì§ˆê²½ì˜íŒ€" class="team-btn">í’ˆì§ˆê²½ì˜íŒ€</button>
                <button data-team="ì „ì¥ì‚¬ì—…íŒ€" class="team-btn">ì „ì¥ì‚¬ì—…íŒ€</button>
                <button data-team="ë©”ì¹´íŠ¸ë¡œë‹‰ìŠ¤íŒ€" class="team-btn">ë©”ì¹´íŠ¸ë¡œë‹‰ìŠ¤íŒ€</button>
                <button data-team="ì˜ì—…íŒ€" class="team-btn">ì˜ì—…íŒ€</button>
                <button data-team="í†µí•©êµ¬ë§¤íŒ€" class="team-btn">í†µí•©êµ¬ë§¤íŒ€</button>
                <button data-team="FPCBì‚¬ì–‘íŒ€" class="team-btn">FPCB ì‚¬ì–‘íŒ€</button>
                <button data-team="ê°œë°œíŒ€" class="team-btn">ê°œë°œíŒ€</button>
                <button data-team="ì¤‘ì•™ì—°êµ¬ì†Œ" class="team-btn">ì¤‘ì•™ì—°êµ¬ì†Œ</button>
            </div>
        </div>
        
        <h2 class="text-xl font-semibold text-gray-700 mb-4 mt-8">êµìœ¡ ì£¼ìš” ì§€í‘œ í˜„í™©</h2>

        <!-- START: ì´ì› ìƒì„¸ ëª©ë¡ (ê³ ì • ì„¹ì…˜) -->
        <div id="employeeChartFixedContainer" class="bg-indigo-50 rounded-xl shadow-inner border border-indigo-200 mb-6 p-4">
            <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2 flex justify-between items-center">
                <span>ì´ì› ìƒì„¸ ëª©ë¡ (íŒ€ë³„ í˜„í™©)</span>
                <!-- ì´ ì¸ì›ìˆ˜ë¥¼ ì—¬ê¸°ì— í‘œì‹œ -->
                <span id="fixed-total-employees" class="text-lg font-extrabold text-indigo-700">ì´ì› (0ëª…)</span>
            </h3> 
            
            <div class="space-y-4">
                <!-- 1. Chart and Summary Area -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 pb-4">
                    <div class="h-64 bg-white rounded-xl p-3 shadow-md">
                        <canvas id="teamHeadcountPieChart"></canvas>
                    </div>
                    <!-- ì˜¤ë¥¸ìª½ íŒ€ë³„ ì¸ì› ìš”ì•½ ë° í˜¸ë²„ ì‹œ ì§ì› ëª…ë‹¨ í‘œì‹œ ì˜ì—­ -->
                    <div id="teamHeadcountSummary" class="space-y-2 custom-scroll max-h-64 p-2 bg-indigo-100/50 rounded-xl border border-indigo-200">
                        <p class="text-center text-gray-500 p-4">íŒ€ë³„ ì¸ì› í†µê³„ ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- END: ì´ì› ìƒì„¸ ëª©ë¡ (ê³ ì • ì„¹ì…˜) -->

        <!-- START: ì—°ê°„ êµìœ¡ ëª©í‘œ ìƒì„¸ (ê³ ì • ì„¹ì…˜) -->
        <div id="achievementChartFixedContainer" class="bg-blue-50 rounded-xl shadow-inner border border-blue-200 mb-6 p-4">
            <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2 flex justify-between items-center">
                <span>ì—°ê°„ êµìœ¡ ëª©í‘œ ìƒì„¸ (íŒ€ë³„ í˜„í™©)</span>
                <div class="flex items-center text-lg">
                    <span class="text-gray-600 text-sm font-medium mr-2">ë³¸ë¶€ ë‹¬ì„±ìœ¨:</span>
                    <span id="fixed-achievement-rate" class="font-extrabold text-blue-700">N/A</span>
                </div>
            </h3> 
            <p id="achievementChartInfoTextInline" class="text-sm text-gray-600 mb-4"></p>
            <div class="h-64">
                <canvas id="deptAchievementBarChart"></canvas>
            </div>
            <!-- ì¶”ê°€: íŒ€ë³„ ëª©í‘œ ìƒì„¸ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ -->
            <div id="achievementGoalsListContainer" class="mt-4">
                <!-- JSì—ì„œ ë‚´ìš©ì´ ì±„ì›Œì§‘ë‹ˆë‹¤. -->
            </div>
        </div>
        <!-- END: ì—°ê°„ êµìœ¡ ëª©í‘œ ìƒì„¸ (ê³ ì • ì„¹ì…˜) -->
        
        <!-- ì˜ë¬´êµìœ¡ ë¯¸ì™„ë£Œ ì¸ì› í˜„í™© (ìœ„ì¹˜ ì¡°ì •ë¨) -->
        <div id="mandatoryComplianceContainer" class="mt-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 cursor-pointer p-4 bg-white rounded-lg shadow-md border-l-4 border-gray-300 hover:bg-gray-100 transition" onclick="toggleDetail(this)">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3"><span class="text-xl font-bold text-gray-800">ì˜ë¬´êµìœ¡ ë¯¸ì™„ë£Œ ì¸ì› í˜„í™© (ì‚¬ì™¸êµìœ¡ 12h ë¯¸ë§Œ)</span></div>
                    <div class="flex items-center space-x-2"><span class="text-red-700 font-bold text-lg"><span id="mandatoryCount">0</span>ëª…</span>
                        <svg class="w-5 h-5 text-gray-500 toggle-icon inline-block transition-transform duration-300 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </div>
                </div>
            </h2>
            <div id="mandatoryComplianceList" class="detail-content custom-scroll max-h-96 border border-gray-200 rounded-lg bg-white flex flex-wrap gap-2">
            </div>
        </div>
        
        <!-- NEW SECTION: êµìœ¡ ê´€ì‹¬ í‚¤ì›Œë“œ (ìœ„ì¹˜ ì¡°ì •ë¨) -->
        <h2 class="text-xl font-semibold text-gray-700 mt-8 mb-4">êµìœ¡ ê´€ì‹¬ í‚¤ì›Œë“œ</h2>
        <div id="topHashtagsContainer" class="p-4 bg-gray-50 rounded-lg shadow-md border border-gray-200 mb-6">
            <span class="text-gray-500 text-sm italic">ì£¼ìš” ê´€ì‹¬ì‚¬ ë¡œë”© ì¤‘...</span>
        </div>
        <!-- END NEW SECTION -->

        <!-- í•„í„° ì˜ì—­ -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-gray-100 rounded-lg border border-gray-200">
            <div><label for="filterSubject" class="block text-sm font-medium text-gray-700 mb-1">êµìœ¡ëª… ê²€ìƒ‰</label><input type="text" id="filterSubject" placeholder="êµìœ¡ëª… í‚¤ì›Œë“œ" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
            <div><label for="filterEmployeeName" class="block text-sm font-medium text-gray-700 mb-1">ì„±ëª… ê²€ìƒ‰ (ì‚¬ë²ˆ)</label><input type="text" id="filterEmployeeName" placeholder="ì„±ëª… ë˜ëŠ” ì‚¬ë²ˆ" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></div>
            <div>
                <label for="filterPosition" class="block text-sm font-medium text-gray-700 mb-1">ì§ì±…</label>
                <select id="filterPosition" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="">ì „ì²´ ì§ì±…</option><option value="íŒ€ì¥">íŒ€ì¥</option><option value="íŒ€ì›">íŒ€ì›</option><option value="ì„ì›">ì„ì›</option><option value="ë§¤ë‹ˆì €">ë§¤ë‹ˆì €</option>
                </select>
            </div>
            <div>
                <label for="filterStatus" class="block text-sm font-medium text-gray-700 mb-1">êµ¬ë¶„ (ìƒíƒœ)</label>
                <select id="filterStatus" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <option value="">ì „ì²´ ìƒíƒœ</option><option value="COMPLETED">êµìœ¡ ì™„ë£Œ</option><option value="IN_PROGRESS">êµìœ¡ ì§„í–‰ì¤‘</option>
                </select>
            </div>
        </div>
        
        <!-- ê²€ìƒ‰/ì´ˆê¸°í™” ë²„íŠ¼ -->
        <div class="flex justify-end space-x-2 px-4 pb-4">
            <button id="applyFilters" class="w-32 px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition shadow-md">ê²€ìƒ‰</button>
            <button id="clearFilters" class="w-32 px-4 py-2 bg-gray-400 text-white font-semibold rounded-lg hover:bg-gray-500 transition shadow-md">ì´ˆê¸°í™”</button>
        </div>

        <!-- êµìœ¡ ì´ë ¥ ëª©ë¡ (ìœ„ì¹˜ ì¡°ì •ë¨) -->
        <h2 class="text-xl font-semibold text-gray-700 mb-4 mt-8">êµìœ¡ ì´ë ¥ ëª©ë¡ (<span id="resultCount">0</span>ê±´)</h2>
        <div id="educationList" class="education-list custom-scroll max-h-96 border border-gray-200 rounded-lg p-4 bg-gray-50 space-y-3">
            <p class="text-center text-gray-500 p-8" id="loadingMessage">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
    </div>

    <!-- Education Detail Modal -->
    <div id="educationModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 transition-opacity duration-300" onclick="closeDetailModal()">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all p-6 sm:p-8" onclick="event.stopPropagation()">
                <!-- Modal Header -->
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h1 class="text-2xl font-bold text-indigo-700">êµìœ¡ ìƒì„¸ ì´ë ¥</h1>
                    <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-700 transition">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
                <!-- Modal Content -->
                <div id="modalContent">
                </div>
            </div>
        </div>
    </div>
    <!-- End Modal -->
    
</body>
</html>