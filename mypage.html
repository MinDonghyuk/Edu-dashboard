<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사내 정보 공유 허브 (경량화)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .main-content-section:not(.active) { display: none; }
        .main-content-section.active { display: block; }
        
        /* 스크롤바 스타일링 유지 */
        .db-scroll-area::-webkit-scrollbar { width: 6px; }
        .db-scroll-area::-webkit-scrollbar-thumb { background-color: #a5b4fc; border-radius: 3px; }
        .db-scroll-area::-webkit-scrollbar-track { background-color: #e5e7eb; border-radius: 3px; }
        .db-scroll-area { scrollbar-width: thin; scrollbar-color: #a5b4fc #e5e7eb; }

        #individual-history-list::-webkit-scrollbar { width: 8px; }
        #individual-history-list::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        #individual-history-list::-webkit-scrollbar-track { background-color: #f1f5f9; }
        #individual-history-list { scrollbar-width: thin; scrollbar-color: #cbd5e1 #f1f5f9; }

        .progress-bar > div { transition: width 0.5s ease-in-out; }
        
        /* 캘린더 일정 표시 스타일 */
        .schedule-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 2px; }
        .schedule-vacation { background-color: #f87171; }
        .schedule-meeting { background-color: #3b82f6; }
        .schedule-training { background-color: #10b981; }
        
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 md:p-8">

    <!-- Global Message Box -->
    <div id="message-box" class="fixed bottom-4 right-4 p-4 text-white rounded-lg shadow-xl z-50 transition-transform transform translate-x-full bg-blue-500"></div>

    <!-- 금년도 교육계획 작성 모달 -->
    <div id="annual-plan-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto transform transition-transform duration-300 scale-100" onclick="event.stopPropagation()">
            <form onsubmit="window.saveAnnualPlan(event)" class="p-6 bg-white rounded-xl space-y-4">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-2xl font-bold text-indigo-700">금년도 교육계획 작성</h3>
                    <button type="button" onclick="closeModal('annual-plan-modal')" class="p-2 text-gray-500 hover:text-gray-900 rounded-full hover:bg-gray-100 transition duration-150" aria-label="닫기">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"></path><path d="M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="bg-red-50 border-l-4 border-red-400 text-red-700 p-3 text-sm" role="alert">
                    <p class="font-semibold">⚠️ 기능 비활성화</p>
                    <p>이 양식은 데이터 로직이 제거되어 작동하지 않습니다.</p>
                </div>
                <div>
                    <label for="plan-title" class="block text-sm font-medium text-gray-700 mb-1">계획 제목</label>
                    <input id="plan-title" type="text" name="plan-title" placeholder="예: 2026년 클라우드 엔지니어링 역량 강화" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required disabled>
                </div>
                <div>
                    <label for="course-details" class="block text-sm font-medium text-gray-700 mb-1">세부 교육 과정 및 목표</label>
                    <textarea id="course-details" rows="8" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" required disabled></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="closeModal('annual-plan-modal')" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-100 transition duration-150 font-semibold">취소</button>
                    <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700 transition duration-150 shadow-md flex items-center" disabled>
                        저장 (비활성화)
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 개인 일정 추가 모달 -->
    <div id="schedule-add-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm transform transition-transform duration-300 scale-100" onclick="event.stopPropagation()">
            <form onsubmit="window.saveUserSchedule(event)" class="p-6 bg-white rounded-xl space-y-4">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 class="text-xl font-bold text-teal-700">개인 일정 추가</h3>
                    <button type="button" onclick="closeModal('schedule-add-modal')" class="p-2 text-gray-500 hover:text-gray-900 rounded-full hover:bg-gray-100 transition duration-150" aria-label="닫기">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"></path><path d="M6 6l12 12"></path></svg>
                    </button>
                </div>
                <div class="bg-red-50 border-l-4 border-red-400 text-red-700 p-3 text-sm" role="alert">
                    <p class="font-semibold">⚠️ 기능 비활성화</p>
                    <p>이 양식은 데이터 로직이 제거되어 작동하지 않습니다.</p>
                </div>
                <div>
                    <label for="schedule-title" class="block text-sm font-medium text-gray-700 mb-1">일정 제목</label>
                    <input id="schedule-title" type="text" name="schedule-title" placeholder="예: 팀 회식" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required disabled>
                </div>
                <div>
                    <label for="schedule-date" class="block text-sm font-medium text-gray-700 mb-1">날짜</label>
                    <input id="schedule-date" type="date" name="schedule-date" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required disabled>
                </div>
                <div>
                    <label for="schedule-type" class="block text-sm font-medium text-gray-700 mb-1">일정 유형</label>
                    <select id="schedule-type" name="schedule-type" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" required disabled>
                        <option value="meeting">회의/행사 (파랑)</option>
                        <option value="training">교육/워크숍 (초록)</option>
                        <option value="vacation">휴가/자리비움 (빨강)</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-lg font-bold hover:bg-teal-700 transition duration-150 shadow-md flex items-center" disabled>저장 (비활성화)</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 일별 상세 일정 모달 -->
    <div id="day-detail-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4 z-50 transition-opacity duration-300 opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto transform transition-transform duration-300 scale-100" onclick="event.stopPropagation()">
            <div class="p-6 bg-white rounded-xl space-y-4">
                <div class="flex justify-between items-center border-b pb-3 mb-4">
                    <h3 id="day-detail-date" class="text-xl font-bold text-indigo-700">상세 일정</h3>
                    <button type="button" onclick="closeModal('day-detail-modal')" class="p-2 text-gray-500 hover:text-gray-900 rounded-full hover:bg-gray-100 transition duration-150" aria-label="닫기">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18"></path><path d="M6 6l12 12"></path></svg>
                    </button>
                </div>
                <ul id="day-event-list" class="space-y-3">
                    <p class="text-center text-gray-500 p-4">등록된 일정이 없습니다. (데이터 로직 제거됨)</p>
                </ul>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <!-- Column 1: 사이드바/네비게이션 -->
        <aside class="lg:col-span-1 space-y-6">
            <header class="p-4 bg-white rounded-xl shadow-lg border-t-4 border-indigo-500">
                <div class="flex justify-between items-center mb-2">
                    <h1 class="text-2xl font-extrabold text-indigo-700">마이 페이지</h1>
                    <button onclick="goBack()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200 transition">
                        &larr; 메인으로
                    </button>
                </div>
                <div id="loading-indicator" class="mt-2 text-indigo-500 font-semibold flex items-center hidden">
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    데이터 로드 중...
                </div>
            </header>

            <!-- 개인 프로필 -->
            <div class="bg-white p-4 rounded-xl shadow-lg border-t-4 border-teal-500">
                <h3 class="text-lg font-bold text-teal-700 mb-3 border-b pb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    개인 프로필
                </h3>
                
                <div id="personal-info-display" class="p-5 border border-teal-200 bg-teal-50 rounded-lg space-y-1 text-sm">
                    <div class="grid grid-cols-2 gap-y-5 gap-x-4 text-sm">
                        <div class="col-span-1 flex flex-col">
                            <strong class="text-xs font-semibold text-gray-500">이름:</strong>
                            <span id="info-name" class="font-semibold text-gray-800">-</span>
                        </div>
                        <div class="col-span-1 flex flex-col">
                            <strong class="text-xs font-semibold text-gray-500">사번:</strong>
                            <span id="info-employeeId" class="text-gray-800">-</span>
                        </div>
                        <div class="col-span-2 flex flex-col">
                            <strong class="text-xs font-semibold text-gray-500">부서:</strong>
                            <span id="info-dept" class="text-gray-800">-</span>
                        </div>
                        <div class="col-span-1 flex flex-col">
                            <strong class="text-xs font-semibold text-gray-500">직책:</strong>
                            <span id="info-pos" class="text-gray-800">-</span>
                        </div>
                        <div class="col-span-1 flex flex-col">
                            <strong class="text-xs font-semibold text-gray-500">이메일:</strong>
                            <span id="info-email" class="text-gray-800 break-all">-</span>
                        </div>
                    </div>
                    <!-- API 상태 표시용 -->
                    <div id="api-status-msg" class="hidden text-xs text-red-500 pt-2 border-t border-red-200 mt-2"></div>
                </div>
                
                <!-- 로그아웃 버튼 -->
                <div class="mt-4 pt-3 border-t border-gray-100">
                    <button onclick="handleLogout()" class="w-full text-center text-red-500 hover:text-red-700 text-sm font-medium py-2 hover:bg-red-50 rounded transition">
                        로그아웃
                    </button>
                </div>
            </div>

            <!-- 네비게이션 메뉴 -->
            <nav id="sidebar-nav" class="bg-white p-2 rounded-xl shadow-lg space-y-1 h-80">
                <h3 class="text-sm font-semibold text-gray-500 px-3 pt-2 pb-1">메뉴</h3>
                <button data-content="personal-info-section" onclick="switchMainContent('personal-info-section')" class="w-full text-left flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150 active bg-indigo-100 text-indigo-700 font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21v-2a4 4 0 00-4-4H9a4 4 0 00-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg> 금년도 교육 현황
                </button>
                <button data-content="individual-history-section" onclick="switchMainContent('individual-history-section')" class="w-full text-left flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6h11"></path><path d="M8 12h11"></path><path d="M8 18h11"></path><path d="M4 6.5l-1.5 1.5l-2.5 -3"></path><path d="M4 12.5l-1.5 1.5l-2.5 -3"></path><path d="M4 18.5l-1.5 1.5l-2.5 -3"></path></svg> 교육 이수 이력
                </button>
                <button data-content="interest-list-section" onclick="switchMainContent('interest-list-section')" class="w-full text-left flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="6"></circle><circle cx="12" cy="12" r="2"></circle></svg> 저장 목록
                </button>
                <button data-content="sharing-board-section" onclick="switchMainContent('sharing-board-section')" class="w-full text-left flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M11 4a9 9 0 0 1 9 9"></path><path d="M21 21l-7.38-7.38"></path></svg> 교육 공유 게시판
                </button>
                <button data-content="inquiry-section" onclick="switchMainContent('inquiry-section')" class="w-full text-left flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><path d="M12 11h4"></path><path d="M12 16h4"></path><path d="M8 11h.01"></path><path d="M8 16h.01"></path></svg> 문의/작성 이력
                </button>
            </nav>
        </aside>

        <!-- Column 2: 메인 컨텐츠 영역 -->
        <main class="lg:col-span-3 space-y-8">

            <!-- 1. 대시보드 (개인 계획 및 일정) 섹션 -->
            <div id="personal-info-section" class="main-content-section bg-white p-4 rounded-xl shadow-lg border-t-4 border-indigo-500 active space-y-2">
                <h2 class="text-2xl font-bold text-gray-700 mb-2">대시보드: 개인 계획 및 일정</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 h-[300px]">
                    <!-- Upcoming List (1/3) -->
                    <div class="lg:col-span-1 bg-gray-50 p-2 rounded-xl border border-indigo-200 shadow-md h-full flex flex-col">
                        <h4 class="text-lg font-bold text-indigo-700 mb-3 flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> 
                            가장 가까운 일정
                        </h4>
                        <div id="upcoming-list-container" class="space-y-3 db-scroll-area overflow-y-auto flex-grow">
                            <p class="text-gray-500 p-2 text-sm">등록된 일정이 없습니다.</p>
                        </div>
                    </div>
                    <!-- Calendar (2/3) -->
                    <div class="lg:col-span-2 bg-white p-2 rounded-xl shadow-md border border-indigo-200 h-full flex flex-col">
                        <div class="flex justify-between items-center mb-1">
                            <h4 class="text-lg font-bold text-indigo-700">캘린더</h4>
                            <button onclick="openModal('schedule-add-modal')" class="px-3 py-1 text-sm font-semibold rounded-lg bg-teal-600 text-white hover:bg-teal-700 transition duration-150 shadow-md flex items-center" disabled>
                                + 개인 일정 추가 (비활성화)
                            </button>
                        </div>
                        <div id="calendar-container" class="select-none flex-grow text-center text-gray-500 flex items-center justify-center">
                             캘린더 로드 중...
                        </div>
                        <div class="flex space-x-4 justify-end text-xs text-gray-600 pt-2 border-t mt-auto">
                            <span class="flex items-center"><span class="schedule-dot schedule-meeting mr-1"></span>회의/행사</span>
                            <span class="flex items-center"><span class="schedule-dot schedule-training mr-1"></span>교육/워크숍</span>
                            <span class="flex items-center"><span class="schedule-dot schedule-vacation mr-1"></span>휴가/자리비움</span>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row md:space-x-8 space-y-2 md:space-y-0">
                    <!-- 서브 섹션 2: 연간 교육 계획 -->
                    <div class="w-full md:w-2/3"> 
                        <h3 class="text-xl font-semibold text-gray-700 mb-2 border-b pb-2">금년도 교육 계획</h3>
                        <div id="annual-plan-display">
                            <div class="p-4 bg-white border border-indigo-300 rounded-xl shadow-inner space-y-2 h-80 flex flex-col justify-between">
                                <p class="text-xs font-semibold text-gray-500">나의 금년도 교육 계획</p>
                                <div class="flex justify-between items-start">
                                    <p class="text-lg font-bold text-gray-500 truncate pr-4">데이터 로드 불가</p>
                                    <span class="text-xs font-semibold px-3 py-1 rounded-full bg-gray-500 text-white flex-shrink-0">비활성화</span>
                                </div>
                                <p class="text-sm text-gray-600 whitespace-pre-wrap max-h-16 overflow-hidden border-l-2 pl-2 border-gray-200">연동된 데이터가 없습니다.</p>
                                <div class="flex justify-between items-center pt-2 border-t border-gray-100 text-xs text-gray-500">
                                    <span>작성일: -</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 서브 섹션 1: 교육 달성률 요약 -->
                    <div class="w-full md:w-1/3"> 
                        <h3 class="text-xl font-semibold text-gray-700 mb-2 border-b pb-2">교육 달성률 요약</h3>
                        <div id="achievement-summary-display" class="p-4 border border-indigo-200 bg-indigo-50 rounded-lg h-60 text-sm text-gray-500 flex items-center justify-center">
                            데이터 집계 중...
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. 교육 이수 이력 섹션 -->
            <div id="individual-history-section" class="main-content-section">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-indigo-600 min-h-[400px]">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-700">교육 이수 이력</h2>
                    </div>
                    <div class="flex space-x-4 mb-4 items-center">
                        <h3 class="text-lg font-semibold text-gray-600">상세 이력 목록</h3>
                        <select id="type-filter" disabled class="p-2 border border-gray-300 rounded-lg text-sm bg-gray-100"><option>형태 전체</option></select>
                        <select id="refund-filter" disabled class="p-2 border border-gray-300 rounded-lg text-sm bg-gray-100"><option>환급 전체</option></select>
                    </div>
                    <ul id="individual-history-list" class="space-y-2 max-h-96 overflow-y-auto pr-2 border border-gray-200 rounded-lg p-2 bg-white db-scroll-area">
                        <p class="text-red-500 p-2 font-semibold">⚠️ 이수 내역이 없습니다.</p>
                    </ul>
                </div>
            </div>

            <!-- 3. 관심 교육 리스트 섹션 -->
            <div id="interest-list-section" class="main-content-section">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-600 min-h-[250px]">
                    <h2 class="text-2xl font-bold text-gray-700 mb-6">저장 목록</h2>
                    <div class="p-4 border border-blue-200 rounded-lg space-y-4 bg-gray-50">
                         <p class="text-center text-gray-500 p-4">저장된 목록이 없습니다.</p>
                    </div>
                </div>
            </div>
            
            <!-- 4. 교육 공유 게시판 섹션 -->
            <div id="sharing-board-section" class="main-content-section">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-teal-500">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">교육 공유 게시판</h2>
                    <div id="shared-list" class="space-y-4 max-h-96 overflow-y-auto pr-2 db-scroll-area">
                        <p class="text-center text-gray-500 p-4">게시물이 없습니다.</p>
                    </div>
                </div>
            </div>
            
            <!-- 5. 문의/작성 이력 섹션 -->
            <div id="inquiry-section" class="main-content-section">
                <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-amber-500 min-h-[250px]">
                    <h2 class="text-2xl font-bold text-gray-700 mb-4">문의 / 작성 이력</h2>
                    <ul id="inquiry-history-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 db-scroll-area">
                        <p class="text-center text-gray-500 p-4">이력이 없습니다.</p>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- 설정 및 상태 변수 ---
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzFfTsWR4aE-uUVltWp0wgSk6_whgawDlni1hALxLGMuB-FsMDnKnDcVqtDk_j6WA66/exec";
        let currentUser = { name: '', uid: '' };
        let currentCalendarDate = new Date();

        // --- 유틸리티 함수: 아이콘 생성 ---
        function getIconSVG(name, classes) {
            const icons = {
                'Pencil': '<path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>',
                'Check': '<polyline points="20 6 9 17 4 12"></polyline>',
                'X': '<path d="M18 6L6 18"></path><path d="M6 6l12 12"></path>'
            };
            return `<svg xmlns="http://www.w3.org/2000/svg" class="${classes}" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">${icons[name] || ''}</svg>`;
        }

        // --- 초기화 로직 ---
        window.onload = async function() {
            const loading = document.getElementById('loading-indicator');
            if(loading) loading.classList.remove('hidden');

            // 1. URL 및 세션 확인
            const params = new URLSearchParams(window.location.search);
            let name = params.get('name');
            let uid = params.get('uid');

            if (!name || !uid) {
                const session = localStorage.getItem('edu_user_session');
                if (session) {
                    try {
                        const parsed = JSON.parse(session);
                        name = parsed.name;
                        uid = parsed.uid;
                    } catch(e) { console.error(e); }
                }
            }

            // 2. 비로그인 시 처리
            if (!name || !uid) {
                alert("로그인 정보가 없습니다.");
                safeNavigate('index.html');
                return;
            }

            // 3. 상태 업데이트 및 UI 반영
            currentUser.name = name;
            currentUser.uid = uid;
            
            // 데이터 바인딩 (수정된 HTML ID 사용)
            const nameEl = document.getElementById('info-name');
            const uidEl = document.getElementById('info-employeeId');
            if(nameEl) nameEl.textContent = name;
            if(uidEl) uidEl.textContent = uid;

            // 4. 데이터 로드 및 렌더링
            await fetchUserDetails(uid);
            renderCalendar();
            
            if(loading) loading.classList.add('hidden');
        };

        // --- 안전한 페이지 이동 (미리보기 오류 방지) ---
        function safeNavigate(url) {
            try {
                window.location.href = url;
            } catch (e) {
                console.warn("이동 차단됨 (미리보기 환경):", url);
                alertMessage("페이지 이동이 차단되었습니다: " + url);
            }
        }

        function goBack() {
            const url = `community.html?name=${encodeURIComponent(currentUser.name)}&uid=${encodeURIComponent(currentUser.uid)}`;
            safeNavigate(url);
        }

        function handleLogout() {
            if(confirm("정말 로그아웃 하시겠습니까?")) {
                localStorage.removeItem('edu_user_session');
                safeNavigate('index.html');
            }
        }

        // --- 구글 시트 데이터 가져오기 ---
        async function fetchUserDetails(uid) {
            const elEmail = document.getElementById('info-email');
            const elDept = document.getElementById('info-dept');
            const elPos = document.getElementById('info-pos');
            const statusMsg = document.getElementById('api-status-msg');

            if(elEmail) elEmail.textContent = '...';
            if(elDept) elDept.textContent = '...';
            if(elPos) elPos.textContent = '...';

            try {
                const response = await fetch(APPS_SCRIPT_URL);
                const text = await response.text();
                
                if (text.trim().startsWith('<')) throw new Error("서버 응답 오류");
                const json = JSON.parse(text);

                if (json.status === 'success' && Array.isArray(json.data)) {
                    const user = json.data.find(u => String(u.userUid) === String(uid));
                    if (user) {
                        if(elEmail) elEmail.textContent = user.sysmail || '-';
                        if(elDept) elDept.textContent = user.deptName || '-';
                        if(elPos) elPos.textContent = user.gradeName || '-';
                        if(statusMsg) {
                            statusMsg.textContent = "최신 정보를 불러왔습니다.";
                            statusMsg.className = "text-xs text-green-600 pt-2 border-t border-green-200 mt-2 block";
                        }
                    } else {
                        if(elEmail) elEmail.textContent = '정보 없음';
                        if(statusMsg) {
                            statusMsg.textContent = "상세 정보를 찾을 수 없습니다.";
                            statusMsg.className = "text-xs text-red-500 pt-2 border-t border-red-200 mt-2 block";
                        }
                    }
                }
            } catch (error) {
                console.error(error);
                if(elEmail) elEmail.textContent = '실패';
                if(statusMsg) statusMsg.textContent = "데이터 로드 실패";
            }
        }

        // --- UI 헬퍼 함수들 ---
        function switchMainContent(contentId) {
            document.querySelectorAll('#sidebar-nav button').forEach(btn => {
                btn.className = 'w-full text-left flex items-center p-3 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-150';
            });
            const activeBtn = document.querySelector(`#sidebar-nav button[data-content="${contentId}"]`);
            if (activeBtn) activeBtn.className += ' bg-indigo-100 text-indigo-700 font-bold active';

            document.querySelectorAll('.main-content-section').forEach(sec => sec.classList.remove('active'));
            const targetSection = document.getElementById(contentId);
            if(targetSection) targetSection.classList.add('active');
        }

        function openModal(id) { document.getElementById(id)?.classList.remove('hidden', 'opacity-0'); }
        function closeModal(id) { document.getElementById(id)?.classList.add('hidden', 'opacity-0'); }
        
        window.alertMessage = function(msg) {
            const box = document.getElementById('message-box');
            box.textContent = msg;
            box.classList.remove('translate-x-full');
            setTimeout(() => box.classList.add('translate-x-full'), 3000);
        }

        // 캘린더 렌더링 (UI 전용)
        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            if (!container) return;
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            let html = `
                <div class="flex justify-between items-center mb-4 px-2">
                    <button onclick="changeMonth(-1)" class="font-bold text-lg p-1 hover:bg-gray-100 rounded">◀</button>
                    <span class="text-lg font-bold text-indigo-700">${year}년 ${month + 1}월</span>
                    <button onclick="changeMonth(1)" class="font-bold text-lg p-1 hover:bg-gray-100 rounded">▶</button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-sm">
                    <div class="text-red-500 font-bold">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-500 font-bold">토</div>
            `;

            for(let i=0; i<firstDay; i++) html += `<div></div>`;
            
            const today = new Date();
            for(let d=1; d<=lastDate; d++) {
                const isToday = (d === today.getDate() && month === today.getMonth() && year === today.getFullYear());
                const bg = isToday ? 'bg-indigo-100 font-bold text-indigo-600 rounded-full' : 'hover:bg-gray-50 rounded';
                html += `<div class="p-2 ${bg}">${d}</div>`;
            }
            html += `</div>`;
            container.innerHTML = html;
        }

        window.changeMonth = function(offset) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + offset);
            renderCalendar();
        }

        // 더미 함수들 (에러 방지용)
        window.saveAnnualPlan = (e) => { e.preventDefault(); alertMessage("기능 준비 중입니다."); closeModal('annual-plan-modal'); };
        window.saveUserSchedule = (e) => { e.preventDefault(); alertMessage("기능 준비 중입니다."); closeModal('schedule-add-modal'); };
    </script>
</body>
</html>
