<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµìœ¡ í˜„í™© ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        .custom-scroll{overflow-y:auto;-webkit-overflow-scrolling:touch}.custom-scroll::-webkit-scrollbar{width:8px}.custom-scroll::-webkit-scrollbar-thumb{background-color:#cbd5e1;border-radius:4px}.custom-scroll::-webkit-webkit-scrollbar-track{background-color:#f1f5f9}.detail-content{transition:max-height .3s ease-out,opacity .3s ease-out,padding .3s ease-out;max-height:0;overflow:hidden;opacity:0;padding:0 1rem}.detail-content.show{max-height:500px;opacity:1;padding-top:1rem;padding-bottom:1rem}
    </style>
    <script>
        tailwind.config={theme:{extend:{fontFamily:{sans:['Inter','Noto Sans KR','sans-serif']},}}}
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8 font-sans">
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        let app, db, auth;
        if(firebaseConfig){
            app=initializeApp(firebaseConfig);
            db=getFirestore(app);
            auth=getAuth(app);
            setLogLevel('Debug');
            async function authenticate(){
                try{
                    if(initialAuthToken){await signInWithCustomToken(auth,initialAuthToken)}
                    else{await signInAnonymously(auth)}
                }catch(error){console.error("Firebase authentication error:",error)}
            }
            authenticate();
        }else{console.warn("Firebase config not found. Skipping Firebase initialization.")}
    </script>

    <div id="app" class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl p-4 sm:p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-3">êµìœ¡ í˜„í™© ëŒ€ì‹œë³´ë“œ</h1>
        <div class="mb-6 flex flex-wrap gap-3">
            <button data-dept="ALL" class="dept-btn px-6 py-2 rounded-full font-semibold text-white bg-blue-600 hover:bg-blue-700 transition shadow-md">ì „ì²´ ë³´ê¸°</button>
            <button data-dept="FPCBì‚¬ì—…ë³¸ë¶€" class="dept-btn px-6 py-2 rounded-full font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition">FPCBì‚¬ì—…ë³¸ë¶€</button>
            <button data-dept="FSì‚¬ì—…ë³¸ë¶€" class="dept-btn px-6 py-2 rounded-full font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition">FSì‚¬ì—…ë³¸ë¶€</button>
            <button data-dept="ê²½ì˜ì§€ì›ë³¸ë¶€" class="dept-btn px-6 py-2 rounded-full font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition">ê²½ì˜ì§€ì›ë³¸ë¶€</button>
            <button data-dept="ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€" class="dept-btn px-6 py-2 rounded-full font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition">ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€</button>
        </div>
        
        <h2 class="text-xl font-semibold text-gray-700 mb-4 mt-8">êµìœ¡ ì£¼ìš” ì§€í‘œ í˜„í™©</h2>
        
        <!-- [ê³ ì •] ì‚¬ì—…ë¶€ë³„ ì¸ì› ë¶„í¬ ìƒì„¸ -->
        <div id="employeeChartDetailContainer" class="bg-gray-100 rounded-xl shadow-inner border border-gray-200 mt-0 mx-2 mb-6 p-4">
            <h3 id="employeeChartDetailTitle" class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">ì´ì› (...)</h3>
            
            <div class="flex flex-col lg:flex-row h-72 sm:h-80 w-full p-2">
                <div class="relative w-full lg:w-1/2 flex justify-center items-center p-2 mb-4 lg:mb-0">
                    <canvas id="deptPieChartInline" class="max-w-md"></canvas>
                </div>
                <div id="employeeListDetail" class="w-full lg:w-1/2 p-2 bg-white rounded-lg shadow-md custom-scroll border border-gray-200">
                    <p class="text-center text-gray-500 p-4 font-semibold text-sm">
                        ì›í˜• ê·¸ë˜í”„ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ ì‚¬ì—…ë¶€ë³„ ìƒì„¸ ëª…ë‹¨ì„ í™•ì¸í•˜ì„¸ìš”.
                    </p>
                </div>
            </div>
            <p id="employeeChartInfoTextInline" class="text-sm text-gray-500 mt-4 text-center">í˜„ì¬ í•„í„°ë§ëœ ë°ì´í„°(ì´ ...ëª…) ê¸°ì¤€ì…ë‹ˆë‹¤.</p>
        </div>
        
        <!-- [2ì—´] KPI ë°•ìŠ¤ -->
        <section id="trainingDashboard" class="grid grid-cols-2 gap-4 mb-0">
            <!-- KPI 1: ì‚¬ìš© ì˜ˆì‚° / í¸ì„± ì˜ˆì‚° -->
            <div id="kpi-budget-status-card" class="kpi-card bg-green-50 p-3 rounded-lg shadow-md border-l-4 border-green-500 transition">
                <p class="text-xs text-gray-600 font-medium">ì‚¬ìš© ì˜ˆì‚° / í¸ì„± ì˜ˆì‚°</p>
                <h3 id="kpi-budget-status" class="text-lg font-bold text-gray-800 mt-0.5">...</h3>
            </div>
            
            <!-- KPI 2: ë¶€ëŒ€ë¹„ìš© ì´ì•¡ -->
            <div id="kpi-incidental-cost-card" class="kpi-card bg-purple-50 p-3 rounded-lg shadow-md border-l-4 border-purple-500 cursor-pointer hover:bg-purple-100 transition" onclick="toggleChart('incidentalCost')">
                <p class="text-xs text-gray-600 font-medium">ë¶€ëŒ€ë¹„ìš© ì´ì•¡</p>
                <h3 id="kpi-incidental-cost" class="text-lg font-bold text-gray-800 mt-0.5">...</h3>
            </div>

            <!-- Detail 1: ì‚¬ì™¸êµìœ¡ ì´ì•¡ ìƒì„¸ -->
            <div id="externalCostChartDetailContainer" class="detail-content col-span-2 bg-yellow-50 rounded-xl shadow-inner border border-yellow-200 mt-0 mx-2">
                <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">ì‚¬ì—…ë¶€ë³„ ì‚¬ì™¸êµìœ¡ ì˜ˆì‚°ì‚¬ìš© ì´ì•¡ ìƒì„¸</h3>
                <div class="relative h-64 sm:h-80 w-full p-2">
                    <canvas id="deptExternalCostBarChart"></canvas>
                </div>
                <p id="externalCostChartInfoTextInline" class="text-sm font-semibold text-gray-700 mt-4 text-center"></p>
            </div>

            <!-- Detail 2: ìƒì‹œí•™ìŠµì§€ì› ì´ì•¡ ìƒì„¸ -->
            <div id="alwaysOnCostChartDetailContainer" class="detail-content col-span-2 bg-red-50 rounded-xl shadow-inner border border-red-200 mt-0 mx-2">
                <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">ì‚¬ì—…ë¶€ë³„ ìƒì‹œí•™ìŠµì§€ì› ì˜ˆì‚°ì‚¬ìš© ì´ì•¡ ìƒì„¸</h3>
                <div class="relative h-64 sm:h-80 w-full p-2">
                    <canvas id="deptAlwaysOnCostBarChart"></canvas>
                </div>
                <p id="alwaysOnCostChartInfoTextInline" class="text-sm font-semibold text-gray-700 mt-4 text-center"></p>
            </div>
            
            <!-- Detail 3: ë¶€ëŒ€ë¹„ìš© ìƒì„¸ ë‚´ì—­ -->
            <div id="incidentalCostChartDetailContainer" class="detail-content col-span-2 bg-purple-50 rounded-xl shadow-inner border border-purple-200 mt-0 mx-2">
                <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">ë¶€ëŒ€ë¹„ìš© ìƒì„¸ ë‚´ì—­ (ì‚¬ì™¸êµìœ¡ ë° ìƒì‹œí•™ìŠµì§€ì›)</h3>
                <div id="incidentalCostDetails" class="space-y-3">
                    <!-- ìƒì„¸ í•­ëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤. --></div>
            </div>
        </section>
        
        <!-- ì‹œë…¸í™ìŠ¤ êµìœ¡ ëª©í‘œ í•­ëª© -->
        <div id="synopexTrainingGoal" class="mt-8 mb-8 p-4 sm:p-6 bg-white border-2 border-dashed border-gray-300 rounded-xl shadow-inner">
            <h2 class="text-xl font-bold text-gray-800 mb-3 flex items-center space-x-2">
                <svg class="w-6 h-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                <span>ì‹œë…¸í™ìŠ¤ êµìœ¡ ëª©í‘œ</span>
            </h2>
            
            <h3 class="text-lg font-bold text-gray-700 mb-3">ì„¸ë¶€ ëª©í‘œ</h3>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm mb-6">
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="font-semibold text-indigo-600">1. ë¹„ì „ ê³µìœ  ë° ê³µê°ëŒ€ í˜•ì„±</p>
                    <p class="text-gray-600 mt-1">íšŒì‚¬ì˜ ë¹„ì „ê³¼ ì „ëµ ë°©í–¥ì„ ëª…í™•íˆ ì „ë‹¬í•˜ê³ , ëª¨ë“  ì„ì§ì›ì˜ ê³µê°ëŒ€ë¥¼ í˜•ì„±í•˜ì—¬ ë‚´ì¬í™”í•œë‹¤.</p>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="font-semibold text-blue-600">2. ì§ë¬´ ì „ë¬¸ì„± ë° ì‹¤í–‰ ì—­ëŸ‰ ê°•í™”</p>
                    <p class="text-gray-600 mt-1">í•µì‹¬ ì¸ì¬ ìœ¡ì„±ê³¼ ì§ë¬´ë³„ ì „ë¬¸ ì§€ì‹ ìŠµë“ì„ í†µí•´ ì—…ë¬´ ì‹¤í–‰ ëŠ¥ë ¥ì„ ê·¹ëŒ€í™”í•œë‹¤.</p>
                </div>
                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                    <p class="font-semibold text-green-600">3. ì¡°ì§ ë¬¸í™” ë° ë¦¬ë”ì‹­ ì—­ëŸ‰ ì œê³ </p>
                    <p class="text-gray-600 mt-1">ë³€í™”ì™€ í˜ì‹ ì„ ì£¼ë„í•  ìˆ˜ ìˆëŠ” ë¦¬ë”ì‹­ì„ í™•ë³´í•˜ê³ , ìˆ˜í‰ì ì´ê³  ì°½ì˜ì ì¸ ì¡°ì§ ë¬¸í™”ë¥¼ êµ¬ì¶•í•œë‹¤.</p>
                </div>
            </div>

            <!-- MOVED KPI CARD: ì‚¬ì—…ë³¸ë¶€ ë³„ ìƒì„¸ -->
            <div id="kpi-target-achievement-card" class="kpi-card bg-blue-50 p-3 rounded-lg shadow-md border-l-4 border-blue-500 cursor-pointer hover:bg-blue-100 transition w-full border-t border-gray-200 pt-3" onclick="toggleChart('achievement')">
                <p class="text-xs text-gray-600 font-medium">ì‚¬ì—…ë³¸ë¶€ ë³„ ìƒì„¸</p>
                <h3 id="kpi-target-achievement" class="text-lg font-bold text-gray-800 mt-0.5"></h3> 
            </div>
            
            <!-- Detail for Achievement Chart: í•´ë‹¹ ì¹´ë“œë¥¼ í´ë¦­í–ˆì„ ë•Œ ë°”ë¡œ ì•„ë˜ì— í‘œì‹œë¨ -->
            <div id="achievementChartDetailContainer" class="detail-content bg-blue-50 rounded-xl shadow-inner border border-blue-200 mt-0 mx-2 col-span-3">
                <h3 class="text-xl font-bold text-gray-700 mb-4 border-b pb-2">ì‚¬ì—…ë³¸ë¶€ë³„ êµìœ¡ ëª©í‘œ ë° ë‹¬ì„±ìœ¨ ìƒì„¸</h3>
                
                <div id="goalAccordionContainer" class="mb-4">
                    <h4 class="cursor-pointer p-3 bg-white rounded-t-lg shadow-md border-b-2 border-blue-200 flex justify-between items-center" onclick="toggleDetail(this.closest('#goalAccordionContainer').querySelector('.detail-content'))">
                        <span class="font-bold text-blue-700">ì‚¬ì—…ë³¸ë¶€ë³„ êµìœ¡ ëª©í‘œ</span>
                        <svg class="w-5 h-5 text-gray-500 toggle-icon transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </h4>
                    <div id="deptGoalSummary" class="detail-content bg-white p-4 border border-t-0 rounded-b-lg">
                        <div class="space-y-3">
                            <!-- Goal HTML content generated by JS will be placed here -->
                        </div>
                    </div>
                </div>

                <div id="chartAccordionContainer" class="mb-4">
                    <h4 class="cursor-pointer p-3 bg-white rounded-t-lg shadow-md border-b-2 border-blue-200 flex justify-between items-center" onclick="toggleDetail(this.closest('#chartAccordionContainer').querySelector('.detail-content'))">
                        <span class="font-bold text-blue-700">ì‚¬ì—…ë³¸ë¶€ë³„ êµìœ¡ ëª©í‘œ ë‹¬ì„±ë¥ </span>
                        <svg class="w-5 h-5 text-gray-500 toggle-icon transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </h4>
                    <div id="chartContent" class="detail-content bg-white p-4 border border-t-0 rounded-b-lg">
                        <div class="relative h-64 sm:h-80 w-full p-2">
                            <canvas id="deptAchievementBarChart"></canvas>
                        </div>
                        <p id="achievementChartInfoTextInline" class="text-sm text-gray-500 mt-4 text-center">í˜„ì¬ í•„í„°ë§ëœ ë°ì´í„° ê¸°ì¤€ ëª©í‘œ ë‹¬ì„±ìœ¨ í˜„í™©ì…ë‹ˆë‹¤.</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
            <div id="keyInterestsContainer">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">ì£¼ìš” êµìœ¡ ê´€ì‹¬ì‚¬ (<span id="currentDeptKeywords">ì „ì²´</span>)</h2>
                <div id="keyInterestsList" class="custom-scroll max-h-96 border border-gray-200 rounded-lg p-4 bg-white space-y-2">
                    <p class="text-center text-gray-500 p-4" id="keywordLoading">ë¶€ì„œë³„ í‚¤ì›Œë“œë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
            </div>
            <div id="topEmployeeContainer">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">ìµœê³  ì´ìˆ˜ ì‹œê°„ ì§ì› í˜„í™© (<span id="topEmployeeCount">0</span>ëª…)</h2>
                <div id="topEmployeesList" class="custom-scroll max-h-96 border border-gray-200 rounded-lg p-4 bg-white space-y-3">
                    <p class="text-center text-gray-500 p-4">ë°ì´í„° ë¡œë”© ì¤‘...</p>
                </div>
            </div>
        </div>

        <div id="mandatoryComplianceContainer" class="mt-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4 cursor-pointer p-4 bg-white rounded-lg shadow-md border-l-4 border-gray-300 hover:bg-gray-100 transition" onclick="toggleDetail(this)">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <span class="text-xl font-bold text-gray-800">ì˜ë¬´êµìœ¡ ë¯¸ì™„ë£Œ ì¸ì› í˜„í™©</span>
                    </div>
                    <div class="flex items-center space-x-2">
                        <span class="text-red-700 font-bold text-lg"><span id="mandatoryCount">0</span>ëª…</span>
                         <svg class="w-5 h-5 text-gray-500 toggle-icon inline-block transition-transform duration-300 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                         </svg>
                    </div>
                </div>
            </h2>
            <div id="mandatoryComplianceList" class="detail-content custom-scroll max-h-96 border border-gray-200 rounded-lg bg-white flex flex-wrap gap-2">
                
            </div>
        </div>
    </div>

    <script>
        const API_KEY='AIzaSyAybqaxn2n1BTB8GKql0c2xBaktc7QkLD0';
        const SPREADSHEET_ID='1JaxcSgP7amAT8N1sM2aa9TbxFAXjY6k9NAay49TyIyc';
        const EXTERNAL_RANGE='ì‚¬ì™¸êµìœ¡!A1:V100';
        const ALWAYS_ON_RANGE='ìƒì‹œí•™ìŠµì§€ì›!A1:V100';
        const ERP_RANGE='ERP!A1:D100';
        const MANDATORY_MINIMUM_HOURS=12;
        const ALLOCATED_BUDGET=100000000; 
        let currentDepartment='ALL';
        let allEducationData=[];
        let allAlwaysOnData=[];
        const MAIN_DEPARTMENTS=['FPCBì‚¬ì—…ë³¸ë¶€','FSì‚¬ì—…ë³¸ë¶€','ê²½ì˜ì§€ì›ë³¸ë¶€','ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€'];
        const DEPARTMENT_COLORS={'FSì‚¬ì—…ë³¸ë¶€':'rgb(59, 130, 246)','FPCBì‚¬ì—…ë³¸ë¶€':'rgb(16, 185, 129)','ê²½ì˜ì§€ì›ë³¸ë¶€':'rgb(250, 204, 21)','ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€':'rgb(99, 102, 241)','ê¸°íƒ€':'rgb(107, 114, 128)'};
        const MOCK_KEYWORD_DATA = {
            'FPCBì‚¬ì—…ë³¸ë¶€': ['Flexible PCB', 'íšŒë¡œ ì„¤ê³„', 'ìƒì‚° íš¨ìœ¨í™”', 'í’ˆì§ˆ ê´€ë¦¬', 'ì²¨ë‹¨ ì†Œì¬'],
            'FSì‚¬ì—…ë³¸ë¶€': ['í´ë¼ìš°ë“œ ë„¤ì´í‹°ë¸Œ', 'AI ëª¨ë¸ë§', 'ë°ì´í„° ë¶„ì„', 'Microservices', 'ë°±ì—”ë“œ ìµœì í™”'],
            'ê²½ì˜ì§€ì›ë³¸ë¶€': ['ì¬ë¬´íšŒê³„', 'ê°œì¸ì •ë³´ë³´í˜¸', 'HR íŠ¸ë Œë“œ', 'ì „ëµ ê¸°íš', 'ë¦¬ìŠ¤í¬ ê´€ë¦¬'],
            'ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€': ['ì˜ë£Œê¸°ê¸° ì¸í—ˆê°€', 'ISO 13485', 'ìƒì²´ ì¬ë£Œ', 'ì„ìƒ ì‹œí—˜', 'í’ˆì§ˆ ë³´ì¦'],
            'ALL': ['ê¸°ìˆ  íŠ¸ë Œë“œ', 'ë¦¬ë”ì‹­ ì—­ëŸ‰', 'ì§ë¬´ ì „ë¬¸ì„±', 'í˜‘ì—… ìŠ¤í‚¬', 'ë¯¸ë˜ ì „ëµ'],
            'ê¸°íƒ€': ['êµì–‘', 'ìê¸°ê³„ë°œ', 'ì–´í•™', 'ì§ì¥ ë¬¸í™”', 'ê¸°íƒ€ ê¸°ìˆ '],
        };
        const MOCK_DEPT_GOALS = {
            'FPCBì‚¬ì—…ë³¸ë¶€': ["ì¹œí™˜ê²½ ì œì¡° ê¸°ìˆ  ì—­ëŸ‰ ê°•í™”", "ì›ê°€ ì ˆê°í˜• ì„¤ê³„ ì „ë¬¸ ì¸ë ¥ ìœ¡ì„±", "ê³ ê°ì‚¬ ë§ì¶¤í˜• ì†”ë£¨ì…˜ ì œê³µ ì—­ëŸ‰ í™•ë³´"],
            'FSì‚¬ì—…ë³¸ë¶€': ["í´ë¼ìš°ë“œ ë° AI ê¸°ë°˜ ì„œë¹„ìŠ¤ ì•„í‚¤í…ì²˜ ì„¤ê³„ ì—­ëŸ‰ í™•ë³´", "ì‹ ê¸°ìˆ  ì ìš©ì„ ìœ„í•œ ì„ í–‰ í•™ìŠµ ì§‘ì¤‘", "ë°ì´í„° ì¤‘ì‹¬ ì˜ì‚¬ê²°ì • ë¬¸í™” ì •ì°©"],
            'ê²½ì˜ì§€ì›ë³¸ë¶€': ["ESG ê²½ì˜ ì²´ì œ í™•ë¦½ì„ ìœ„í•œ ë²•ê·œ ì¤€ìˆ˜ êµìœ¡ ê°•í™”", "ì „ëµì  ì¸ì  ìì› ê´€ë¦¬ ì—­ëŸ‰ ë°°ì–‘", "íš¨ìœ¨ì ì¸ ì¬ë¬´ íšŒê³„ ì‹œìŠ¤í…œ êµ¬ì¶• ì§€ì›"],
            'ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€': ["ì˜ë£Œ ê¸°ê¸° í’ˆì§ˆ ì‹œìŠ¤í…œ(GMP/ISO) ì‹¬í™” êµìœ¡ ì´ìˆ˜", "ë°”ì´ì˜¤ ì†Œì¬ ê°œë°œ ê´€ë ¨ R&D ì—­ëŸ‰ í™•ë³´", "ì„ìƒ ë° ì¸í—ˆê°€ í”„ë¡œì„¸ìŠ¤ ì „ë¬¸ì„± ê°•í™”"],
            'ê¸°íƒ€': ["ê³µí†µ ì§ë¬´ ì—­ëŸ‰ ë° ìê¸° ì£¼ë„ í•™ìŠµ ì§€ì› í™•ëŒ€"],
            'ALL': ["ë¯¸ë˜ ì„±ì¥ ë™ë ¥ í™•ë³´ë¥¼ ìœ„í•œ ì§ë¬´ ì „ë¬¸ì„± 100% ë‹¬ì„±", "ë¦¬ë”ì‹­ ì—­ëŸ‰ ê°•í™” ë° ì¡°ì§ í™œì„±í™”"],
        };

        const achievementChartContainer=document.getElementById('achievementChartDetailContainer');
        const externalCostChartContainer=document.getElementById('externalCostChartDetailContainer');
        const alwaysOnCostChartContainer=document.getElementById('alwaysOnCostChartDetailContainer');
        const incidentalCostChartContainer=document.getElementById('incidentalCostChartDetailContainer');
        
        window.onerror=function(message,source,lineno,colno,error){
            console.error("FATAL UI ERROR:",message,error);
            const appElement=document.getElementById('app');
            if(appElement){appElement.innerHTML='<div class="p-8 text-center bg-red-100 rounded-lg shadow-lg"><h2 class="text-xl font-bold text-red-700">ğŸš¨ ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨ (ì¹˜ëª…ì  JS ì˜¤ë¥˜)</h2><p class="text-red-600 mt-2">ì½˜ì†”ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. (ì½”ë“œ Line: '+lineno+')</p></div>'}
            return true;
        };
        
        function formatCurrency(number){return new Intl.NumberFormat('ko-KR',{style:'currency',currency:'KRW',minimumFractionDigits:0}).format(number)}

        window.toggleDetail=function(element){
            const container=element.closest('.education-item') || element.closest('#mandatoryComplianceContainer') || element.closest('#goalAccordionContainer') || element.closest('#chartAccordionContainer');
            if (!container) return; 
            const detailContainer = container.querySelector('.detail-content');
            const arrowIcon = container.querySelector('.toggle-icon');
            if (!detailContainer) return;
            if(detailContainer.classList.contains('show')){
                detailContainer.classList.remove('show');
                if(arrowIcon) arrowIcon.classList.remove('rotate-180');
            } else {
                document.querySelectorAll('.education-item .detail-content.show, #mandatoryComplianceContainer .detail-content.show, #goalAccordionContainer .detail-content.show, #chartAccordionContainer .detail-content.show').forEach(openDetail => {
                    openDetail.classList.remove('show');
                    const parent = openDetail.closest('.education-item, #mandatoryComplianceContainer, #goalAccordionContainer, #chartAccordionContainer');
                    if (parent) {
                        const openArrow = parent.querySelector('.toggle-icon');
                        if (openArrow) openArrow.classList.remove('rotate-180');
                    }
                });
                detailContainer.classList.add('show');
                if(arrowIcon) arrowIcon.classList.add('rotate-180');
            }
        }

        function toggleChart(chartType){
            const containers={
                'achievement':achievementChartContainer,
                'externalCost':externalCostChartContainer,
                'alwaysOnCost':alwaysOnCostChartContainer,
                'incidentalCost':incidentalCostChartContainer
            };
            const currentContainer=containers[chartType];
            if(!currentContainer)return; 
            const isCurrentlyOpen = currentContainer.classList.contains('show');
            if (currentDepartment !== 'ALL' && chartType !== 'incidentalCost' && chartType !== 'externalCost' && chartType !== 'alwaysOnCost') {
                return; 
            }
            document.querySelectorAll('#trainingDashboard .detail-content.show').forEach(openDetail=>{
                openDetail.classList.remove('show');
            });
            if (!isCurrentlyOpen) {
                currentContainer.classList.add('show');
                if (chartType === 'achievement') {
                    // [MODIFIED] achievement ì°¨íŠ¸ê°€ ì—´ë¦´ ë•Œ, í•˜ìœ„ ì•„ì½”ë””ì–¸ë„ ì—´ê¸°
                    const goalDetail = document.getElementById('deptGoalSummary');
                    const chartDetail = document.getElementById('chartContent');
                    const goalArrow = document.querySelector('#goalAccordionContainer .toggle-icon');
                    const chartArrow = document.querySelector('#chartAccordionContainer .toggle-icon');

                    if (goalDetail) { goalDetail.classList.add('show'); if (goalArrow) goalArrow.classList.add('rotate-180'); }
                    if (chartDetail) { chartDetail.classList.add('show'); if (chartArrow) chartArrow.classList.add('rotate-180'); }
                }
            } else {
                // [NEW LOGIC] achievement ì°¨íŠ¸ê°€ ë‹«í ë•Œ, í•˜ìœ„ ì•„ì½”ë””ì–¸ë„ ë‹«ê¸°
                if (chartType === 'achievement') {
                    const goalDetail = document.getElementById('deptGoalSummary');
                    const chartDetail = document.getElementById('chartContent');
                    const goalArrow = document.querySelector('#goalAccordionContainer .toggle-icon');
                    const chartArrow = document.querySelector('#chartAccordionContainer .toggle-icon');

                    if (goalDetail) { goalDetail.classList.remove('show'); if (goalArrow) goalArrow.classList.remove('rotate-180'); }
                    if (chartDetail) { chartDetail.classList.remove('show'); if (chartArrow) chartArrow.classList.remove('rotate-180'); }
                }
            }
            if(chartType==='incidentalCost'&&currentContainer.classList.contains('show')){
                const currentlyFilteredData = filterAndSortData(); 
                renderIncidentalCostDetails(currentlyFilteredData);
            }
            if (chartType === 'externalCost' && !isCurrentlyOpen) {
                document.getElementById('externalCostChartDetailContainer').classList.add('show');
            } else if (chartType === 'alwaysOnCost' && !isCurrentlyOpen) {
                document.getElementById('alwaysOnCostChartDetailContainer').classList.add('show');
            }
        }
        
        function parseDateSort(periodString){
            const match=periodString.match(/(\d{4})\.(\d{2})/);
            if(match){return parseInt(match[1]+match[2],10)}
            return 0;
        }

        function processERPData(sheetValues){
            const map={};
            const dataRows=sheetValues.slice(1);
            dataRows.forEach(row=>{
                const employeeId=row[0]?.trim();
                const dept=row[2]?.trim();
                const email=row[3]?.trim()?.toLowerCase()||'ì´ë©”ì¼ ë¯¸ë“±ë¡';
                if(employeeId){map[employeeId]={dept:dept||'ê¸°íƒ€',email:email}}
            });
            return map;
        }

        function parseHours(hoursString){
            if(!hoursString)return 0;
            let totalHours=0;
            let match;
            match=hoursString.match(/(\d+(\.\d+)?)\s*ì‹œê°„/);
            if(match){totalHours+=parseFloat(match[1])}
            match=hoursString.match(/(\d+)\s*ë¶„/);
            if(match){totalHours+=parseInt(match[1])/60}
            if(totalHours===0){
                match=hoursString.match(/^(\d+(\.\d+)?)$/); 
                if(match){totalHours=parseFloat(match[1])}
            }
            return parseFloat(totalHours.toFixed(2));
        }
        
        function parseCurrency(costString){
             if(!costString)return 0;
             const cleaned=costString.trim().toLowerCase();
             if(cleaned.includes('ë¬´ë£Œ')||cleaned.includes('ë¬´ìƒ')||cleaned==='0ì›'){return 0}
             const numericString=cleaned.replace(/ì›/g,'').replace(/,/g,'');
             const cost=parseFloat(numericString);
             return isNaN(cost)?0:cost;
        }

        function processSheetData(sheetValues,sourceName,erpMap={}){
            const C={
                completionStatusText:0,employeeName:1,employeeId:2,dept:3,position:4,
                subject:5,type:6,period:7,actualHoursString:8,actualCostString:9,
                isRefundableRaw:10,content:11,purpose:12,expectedEffect:13,summary:14,
                linkage:15,difficulty:16,implementationDate:17,carCostString:18,
                publicTransitCostString:19,lodgingEtcCostString:20,incidentalCostString:21,
                email:18,targetHours:777,budgetedCost:888
            };
            const dataRows=sheetValues.slice(1);
            if(dataRows.length===0){return []}
            return dataRows.map((row,index)=>{
                const employeeId=row[C.employeeId]||`E${index+1}`;
                const erpInfo=erpMap[employeeId];
                let finalDept=row[C.dept]||'ê¸°íƒ€';
                let finalEmail=row[C.email]||'ì´ë©”ì¼ ë¯¸ë“±ë¡'; 
                if(erpInfo){finalDept=erpInfo.dept||finalDept;finalEmail=erpInfo.email||finalEmail}
                const incidentalCosts={
                    carCost:parseCurrency(row[C.carCostString] || '0'),
                    publicTransitCost:parseCurrency(row[C.publicTransitCostString] || '0'),
                    lodgingEtcCost:parseCurrency(row[C.lodgingEtcCostString] || '0'),
                    incidentalCostTotal:parseCurrency(row[C.incidentalCostString] || '0'),
                };
                return{
                    id:`${sourceName}-${index+1}`,period:row[C.period]||'N/A',position:row[C.position]||'ë¯¸ì •',
                    type:row[C.type]||'ë¯¸ì •',subject:row[C.subject]||'ì œëª© ì—†ìŒ',
                    dept:finalDept,source:sourceName,isCompleted:(row[C.completionStatusText]||'').toUpperCase()==='ì™„ë£Œ',
                    completionStatusText:row[C.completionStatusText]||'ì‹ ì²­',employeeName:row[C.employeeName]||'ì´ë¦„ ì—†ìŒ',
                    employeeId:employeeId,targetHours:12,actualHours:parseHours(row[C.actualHoursString] || '0'),
                    budgetedCost:0,actualCost:parseCurrency(row[C.actualCostString] || '0'),
                    ...incidentalCosts,isRefundableRaw:row[C.isRefundableRaw]||'N/A',
                    content:row[C.content]||'ë‚´ìš©ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
                    purpose:row[C.purpose]||'ëª©ì ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
                    expectedEffect:row[C.expectedEffect]||'ê¸°ëŒ€íš¨ê³¼ê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
                    summary:row[C.summary]||'êµìœ¡ ìš”ì•½ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
                    linkage:row[C.linkage]||'ì—…ë¬´ì ìš© ê³„íšì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
                    difficulty:row[C.difficulty]||'ì—…ë¬´ì ìš© ì• ë¡œì‚¬í•­ì´ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.',
                    implementationDate:row[C.implementationDate]||'ì˜ˆìƒ ì—…ë¬´ì ìš© ë°œí˜„ì‹œì ',
                    email:finalEmail,dateSort:parseDateSort(row[C.period]||'N/A'),
                };
            });
        }
        
        function getMockEducationData(sourceName, erpMap) {
            const mockEmployees = Object.keys(erpMap);
            const mockData = [];
            const isExternal = sourceName === 'ì‚¬ì™¸êµìœ¡';
            mockEmployees.forEach((id, index) => {
                const erpInfo = erpMap[id];
                const dept = erpInfo.dept;
                const employeeName = dept.charAt(0) + id.slice(-4);
                const actualHours = isExternal ? Math.max(1, Math.round(Math.random() * 20 + 5)) : Math.round(Math.random() * 10);
                const actualCost = isExternal ? Math.round(Math.random() * 300000 + 500000) : Math.max(0, Math.round(Math.random() * 100000 - 50000));
                const incidentalCostTotal = isExternal ? Math.round(Math.random() * 10000 + 50000) : 0;
                mockData.push({
                    id: `${sourceName}-MOCK-${index + 1}`,period: `2024.0${(index % 6) + 1}~2024.0${(index % 6) + 1}`,position: 'ì‚¬ì›',
                    type: isExternal ? 'ì§ë¬´ ì „ë¬¸' : 'ìê¸°ê³„ë°œ',subject: isExternal ? `${dept} ì „ë¬¸ êµìœ¡ ${index + 1}` : `ìƒì‹œ í•™ìŠµ ëª¨ë“ˆ ${index + 1}`,
                    dept: dept,source: sourceName,isCompleted: true,completionStatusText: 'ì™„ë£Œ',employeeName: employeeName,
                    employeeId: id,targetHours: 12,actualHours: actualHours,budgetedCost: 0,actualCost: actualCost,
                    carCost: isExternal ? incidentalCostTotal * 0.5 : 0,publicTransitCost: isExternal ? incidentalCostTotal * 0.3 : 0,
                    lodgingEtcCost: isExternal ? incidentalCostTotal * 0.2 : 0,incidentalCostTotal: incidentalCostTotal,
                    isRefundableRaw: 'Y',content: 'Mock êµìœ¡ ë‚´ìš©',purpose: 'Mock ëª©ì ',expectedEffect: 'Mock ê¸°ëŒ€íš¨ê³¼',
                    summary: 'Mock ìš”ì•½',linkage: 'Mock ì—…ë¬´ì ìš© ê³„íš',difficulty: 'Mock ì• ë¡œì‚¬í•­',
                    implementationDate: 'Mock ì‹œì ',email: erpInfo.email,dateSort: parseDateSort(`2024.0${(index % 6) + 1}`),
                });
            });
            return mockData;
        }

        async function fetchEducationData(range,sourceName,erpMap){
            const URL=`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
            try{
                if(!API_KEY||!SPREADSHEET_ID){throw new Error(`API í‚¤ ë˜ëŠ” ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. [${sourceName}]`)}
                const response=await fetch(URL);
                if(!response.ok){
                     return getMockEducationData(sourceName, erpMap);
                }
                const data=await response.json();
                return processSheetData(data.values||[],sourceName,erpMap);
            }catch(error){
                if(error.message.includes("Failed to fetch") || error.message.includes("API í‚¤ ë˜ëŠ” ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.") || error.message.includes("API ìš”ì²­ ì‹¤íŒ¨")){
                    return getMockEducationData(sourceName, erpMap);
                }
                //document.getElementById('app').innerHTML=`<div class="p-8 text-center bg-red-100 rounded-lg shadow-lg"><h2 class="text-xl font-bold text-red-700">ğŸš¨ ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${error.message}</h2><p class="text-red-600 mt-2">ì½˜ì†”ì—ì„œ ìì„¸í•œ ì˜¤ë¥˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.</p></div>`;
                return[]
            }
        }

        async function fetchERPData(){
            const range=ERP_RANGE;
            const sourceName='ERP';
            const URL=`https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(range)}?key=${API_KEY}`;
            const MOCK_ERP_DATA_LOCAL={
                '202320458':{dept:'FSì‚¬ì—…ë³¸ë¶€',email:'jdh@company.com'},'202120458':{dept:'ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€',email:'jdh2@company.com'},'202020458':{dept:'FSì‚¬ì—…ë³¸ë¶€',email:'ldh@company.com'},'202220458':{dept:'FPCBì‚¬ì—…ë³¸ë¶€',email:'pdh@company.com'},'202420458':{dept:'ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€',email:'kdh@company.com'},'201920458':{dept:'FPCBì‚¬ì—…ë³¸ë¶€',email:'kdh2@company.com'},'201820458':{dept:'ê²½ì˜ì§€ì›ë³¸ë¶€',email:'mdh@company.com'},'201720458':{dept:'ê²½ì˜ì§€ì›ë³¸ë¶€',email:'adh@company.com'},'201620458':{dept:'FSì‚¬ì—…ë³¸ë¶€',email:'bdh@company.com'},'201520458':{dept:'FPCBì‚¬ì—…ë³¸ë¶€',email:'cdh@company.com'},'201420458':{dept:'ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€',email:'edh@company.com'},'201320458':{dept:'ê²½ì˜ì§€ì›ë³¸ë¶€',email:'fdh@company.com'},
            };
            try{
                if(!API_KEY||!SPREADSHEET_ID){throw new Error(`API í‚¤ ë˜ëŠ” ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. [${sourceName}]`)}
                const response=await fetch(URL);
                if(!response.ok){throw new Error(`API ìš”ì²­ ì‹¤íŒ¨: ${response.status}. ERP ì‹œíŠ¸ ë¡œë”© ì‹¤íŒ¨. [${sourceName}]`)}
                const data=await response.json();
                return processERPData(data.values||[]);
            }catch(error){
                if(error.message.includes("API í‚¤ ë˜ëŠ” ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.") || error.message.includes("API ìš”ì²­ ì‹¤íŒ¨")){
                    return MOCK_ERP_DATA_LOCAL;
                }else{
                    return{}
                }
            }
        }
        
        function getAggregatedEmployeeTargets(data) {
            const employeeMap = {};
            data.forEach(item => {
                const id = item.employeeId;
                const deptKey = MAIN_DEPARTMENTS.includes(item.dept) ? item.dept : 'ê¸°íƒ€';
                if (!employeeMap[id]) {
                    employeeMap[id] = {
                        dept: deptKey, actualHours: 0, externalHours: 0, plannedTargetHours: 0,
                    };
                }
                employeeMap[id].actualHours += item.actualHours;
                if (item.source === 'ì‚¬ì™¸êµìœ¡') { employeeMap[id].externalHours += item.actualHours; }
                employeeMap[id].plannedTargetHours = Math.max(employeeMap[id].plannedTargetHours, item.targetHours || 0);
            });
            return employeeMap;
        }

        function getAggregatedEmployeeData(data){
            const aggregated={};
            data.forEach(item=>{
                if(!aggregated[item.employeeId]){
                    aggregated[item.employeeId]={
                        employeeId:item.employeeId,employeeName:item.employeeName,dept:item.dept,
                        email:item.email,totalHours:0,externalHours:0,items:[]
                    };
                }
                aggregated[item.employeeId].totalHours+=item.actualHours;
                if(item.source==='ì‚¬ì™¸êµìœ¡'){aggregated[item.employeeId].externalHours+=item.actualHours}
                aggregated[item.employeeId].items.push({subject:item.subject,actualHours:item.actualHours,source:item.source,dateSort:item.dateSort,period:item.period});
            });
            return Object.values(aggregated);
        }

        function calculateDeptStats(data){
            const allCombinedData=[...data.filter(item=>item.source==='ì‚¬ì™¸êµìœ¡'), ...data.filter(item=>item.source==='ìƒì‹œí•™ìŠµì§€ì›')];
            const employeeTargets = getAggregatedEmployeeTargets(data); 
            const deptStats={};
            MAIN_DEPARTMENTS.forEach(dept=>{
                deptStats[dept]={totalHours:0,externalHours:0,costTotal:0,alwaysOnCostTotal:0,incidentalCostTotal:0,employeeCount:0,employeeIds:new Set(), plannedTargetTotal: 0, mandatoryTargetTotal: 0, alwaysOnHours: 0}
            });
            deptStats['ê¸°íƒ€']={totalHours:0,externalHours:0,costTotal:0,alwaysOnCostTotal:0,incidentalCostTotal:0,employeeCount:0,employeeIds:new Set(), plannedTargetTotal: 0, mandatoryTargetTotal: 0, alwaysOnHours: 0};

            Object.keys(employeeTargets).forEach(id => {
                const employee = employeeTargets[id];
                const dept = employee.dept;
                if (deptStats[dept]) {
                    deptStats[dept].employeeIds.add(id);
                    deptStats[dept].totalHours += employee.actualHours;
                    deptStats[dept].externalHours += employee.externalHours;
                    deptStats[dept].alwaysOnHours += (employee.actualHours - employee.externalHours); 
                    deptStats[dept].plannedTargetTotal += employee.plannedTargetHours;
                    deptStats[dept].mandatoryTargetTotal += MANDATORY_MINIMUM_HOURS; 
                }
            });

            allCombinedData.forEach(item=>{
                const dept = MAIN_DEPARTMENTS.includes(item.dept) ? item.dept : 'ê¸°íƒ€';
                if (deptStats[dept]) {
                    if (item.source === 'ì‚¬ì™¸êµìœ¡') {
                        deptStats[dept].costTotal += item.actualCost;
                        deptStats[dept].incidentalCostTotal += item.incidentalCostTotal;
                    } else if (item.source === 'ìƒì‹œí•™ìŠµì§€ì›') {
                        deptStats[dept].alwaysOnCostTotal += item.actualCost;
                        deptStats[dept].incidentalCostTotal += item.incidentalCostTotal;
                    }
                }
            });
            MAIN_DEPARTMENTS.concat(['ê¸°íƒ€']).forEach(dept=>{deptStats[dept].employeeCount=deptStats[dept].employeeIds.size});
            return deptStats;
        }

        function renderEmployeeListDetail(deptName, deptColor, totalCount, employeeList) {
            const container = document.getElementById('employeeListDetail');
            if (!container) return;
            const headerBg = deptColor.replace('rgb', 'rgba').replace(')', '), 0.1)');
            const headerColor = deptColor;
            const listHtml = employeeList.map(emp => `
                <div class="flex justify-between items-center text-xs p-2 border-b border-gray-100 last:border-b-0">
                    <span class="font-bold text-gray-700">${emp.employeeName}</span>
                    <span class="text-gray-500">${emp.employeeId}</span>
                    <span class="font-semibold text-green-600">${emp.totalHours.toFixed(1)}h</span>
                </div>
            `).join('');
            container.innerHTML = `
                <div class="h-full flex flex-col">
                    <h4 class="text-lg font-bold p-3 rounded-t-lg mb-2 flex justify-between items-center flex-shrink-0 border-b" style="background-color: ${headerBg}; border-color: ${headerColor}; color: ${headerColor};">
                        <span>${deptName} ëª…ë‹¨</span>
                        <span class="text-base font-extrabold">${totalCount}ëª…</span>
                    </h4>
                    <div class="space-y-1 flex-grow overflow-y-auto">
                        ${listHtml || '<p class="text-center text-gray-500 p-4">í•´ë‹¹ ì‚¬ì—…ë³¸ë¶€ì˜ ì§ì› ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
                    </div>
                </div>
            `;
        }
        
        let allAggregatedEmployeeData = null; 
        function renderAllCharts(filteredData){
            const deptStats=calculateDeptStats(filteredData);
            const deptNames=MAIN_DEPARTMENTS.concat(['ê¸°íƒ€']).filter(d=>deptStats[d].employeeCount>0);
            const deptColors=deptNames.map(d=>DEPARTMENT_COLORS[d]);
            const allCombinedData=[...allEducationData,...allAlwaysOnData];
            const totalEmployees=new Set(allCombinedData.map(item=>item.employeeId)).size;

            allAggregatedEmployeeData = getAggregatedEmployeeData(allCombinedData); 
            renderEmployeeChart(deptStats,deptNames,deptColors,filteredData.length);
            renderAchievementChart(deptStats,deptNames,deptColors);
            renderCostChart('deptExternalCostBarChart',deptStats,deptNames,deptColors,'costTotal','ì‚¬ì™¸êµìœ¡ ì˜ˆì‚°ì‚¬ìš© ì´ì•¡',totalEmployees); 
            renderCostChart('deptAlwaysOnCostBarChart',deptStats,deptNames,deptColors,'alwaysOnCostTotal','ìƒì‹œí•™ìŠµì§€ì› ì˜ˆì‚°ì‚¬ìš© ì´ì•¡',totalEmployees); 
        }

        let employeeChartInstance = null;
        function renderEmployeeChart(deptStats,deptNames,deptColors,totalItems){
            const employeeCounts=deptNames.map(dept=>deptStats[dept].employeeCount);
            const totalUniqueEmployees = employeeCounts.reduce((a,b)=>a+b,0);
            document.getElementById('employeeChartDetailTitle').textContent=`ì´ì› (${totalUniqueEmployees}ëª…)`;
            document.getElementById('employeeChartInfoTextInline').textContent=`í˜„ì¬ ë°ì´í„° (ì´ ${totalItems}ê±´) ê¸°ì¤€ ê³ ìœ  ì¸ì›(${totalUniqueEmployees}ëª…) ë¶„í¬ì…ë‹ˆë‹¤.`;
            if(employeeChartInstance)employeeChartInstance.destroy();
            const ctx=document.getElementById('deptPieChartInline').getContext('2d');
            employeeChartInstance=new Chart(ctx,{
                type:'pie',
                data:{
                    labels:deptNames,
                    datasets:[{data:employeeCounts,backgroundColor:deptColors,hoverOffset:16}]
                },
                options:{
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{
                        legend:{position:'right'},
                        tooltip: { enabled: true, callbacks: { } }
                    },
                    onHover: (event, elements, chart) => {
                        const container = document.getElementById('employeeListDetail');
                        if (!container) return;
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const deptName = chart.data.labels[index];
                            const deptColor = chart.data.datasets[0].backgroundColor[index];
                            const deptCount = chart.data.datasets[0].data[index];
                            const employeeList = Object.values(allAggregatedEmployeeData).filter(
                                emp => emp.dept === deptName
                            ).sort((a, b) => b.totalHours - a.totalHours);
                            renderEmployeeListDetail(deptName, deptColor, deptCount, employeeList);
                        } else {
                            container.innerHTML = `<p class="text-center text-gray-500 p-4 font-semibold text-sm">ì›í˜• ê·¸ë˜í”„ ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë ¤ ì‚¬ì—…ë¶€ë³„ ìƒì„¸ ëª…ë‹¨ì„ í™•ì¸í•˜ì„¸ìš”.</p>`;
                        }
                    }
                }
            });
        }
        
        let achievementChartInstance = null;
        function renderAchievementChart(deptStats,deptNames,deptColors){
            const externalHours=deptNames.map(dept=>deptStats[dept].externalHours);
            const alwaysOnHours=deptNames.map(dept=>deptStats[dept].alwaysOnHours);
            const plannedTargetHours=deptNames.map(dept=>deptStats[dept].plannedTargetTotal);
            const mandatoryTargetHours=deptNames.map(dept=>deptStats[dept].mandatoryTargetTotal);
            const totalActualHours = externalHours.map((h, i) => h + alwaysOnHours[i]);
            const maxTarget = plannedTargetHours.map((p, index) => Math.max(p, mandatoryTargetHours[index]));
            const achievementRates=totalActualHours.map((h, i) => maxTarget[i] > 0 ? (h / maxTarget[i]) * 100 : 0);
            const totalEmployees=deptNames.reduce((sum,dept)=>sum+deptStats[dept].employeeCount,0);
            
            document.getElementById('achievementChartInfoTextInline').textContent=`ì´ì› ${totalEmployees}ëª… ê¸°ì¤€, ì‚¬ì—…ë¶€ë³„ (ì´ ì´ìˆ˜ ì‹œê°„ / ìµœëŒ€ ëª©í‘œ ì‹œê°„) ë‹¬ì„±ìœ¨ í˜„í™©ì…ë‹ˆë‹¤.`;
            if(achievementChartInstance)achievementChartInstance.destroy();
            const ctx=document.getElementById('deptAchievementBarChart').getContext('2d');
            
            achievementChartInstance=new Chart(ctx,{
                type:'bar', 
                data:{
                    labels:deptNames,
                    datasets:[
                        {
                            type: 'bar',label:'ëª©í‘œ ë‹¬ì„±ìœ¨ (%)',data:achievementRates,
                            backgroundColor: deptColors.map(c => c.replace('rgb', 'rgba').replace(')', '), 0.8)')), 
                            borderColor: deptColors,borderWidth: 1,yAxisID: 'y1'
                        }
                    ]
                },
                options:{
                    responsive:true,maintainAspectRatio:false,interaction: { mode: 'index', intersect: false },
                    scales:{
                        x: { stacked: false },
                        y1:{ 
                            type: 'linear',display: true,position: 'left',beginAtZero:true,max: 150, 
                            title:{display:true,text:'ë‹¬ì„±ìœ¨ (%)'},
                            ticks: { callback: function(value) { return value + '%'; } }
                        }
                    },
                    plugins:{
                        legend:{display:false},title:{display:false}, 
                        tooltip: { 
                            mode: 'index', intersect: false,
                            callbacks: { 
                                title: function(context) { return deptNames[context[0].dataIndex]; },
                                label: function(context) { 
                                    const index = context.dataIndex;
                                    const achieved = totalActualHours[index];
                                    const plannedMax = maxTarget[index];
                                    const external = externalHours[index];
                                    let lines = [];
                                    lines.push(`ë‹¬ì„±ìœ¨: ${context.parsed.y.toFixed(1)}%`);
                                    lines.push(`ì´ ëª©í‘œì‹œê°„: ${plannedMax.toFixed(1)}h (ìµœëŒ€ ëª©í‘œ)`);
                                    lines.push(`ì´ ì´ìˆ˜ì‹œê°„: ${achieved.toFixed(1)}h`);
                                    lines.push(`ì‚¬ì™¸(ì˜ë¬´) ì´ìˆ˜ì‹œê°„: ${external.toFixed(1)}h`);
                                    return lines;
                                }
                            }
                        }
                    }
                }
            });
        }

        let externalCostChartInstance = null;
        let alwaysOnCostChartInstance = null;
        function renderCostChart(chartId,deptStats,deptNames,deptColors,dataKey,title,totalEmployees){
            const totalCosts=deptNames.map(dept=>deptStats[dept][dataKey]);
            const totalSum=totalCosts.reduce((a,b)=>a+b,0);
            const averageCost=totalEmployees>0?totalSum/totalEmployees:0;
            const infoElementId=chartId.includes('External')?'externalCostChartInfoTextInline':'alwaysOnCostChartInfoTextInline';
            const infoElement=document.getElementById(infoElementId);
            if(infoElement){infoElement.textContent=`1ì¸ í‰ê·  êµìœ¡ ë¹„ìš©: ${formatCurrency(averageCost)} (ì´ì› ${totalEmployees}ëª… ê¸°ì¤€)`}
            let instanceToDestroy = chartId.includes('External') ? externalCostChartInstance : alwaysOnCostChartInstance;
            if(instanceToDestroy)instanceToDestroy.destroy();
            const canvasCtx = document.getElementById(chartId).getContext('2d');
            const newChart=new Chart(canvasCtx,{
                type:'bar',data:{labels:deptNames,datasets:[{label:'ì‚¬ìš© ê¸ˆì•¡ (ì›)',data:totalCosts,backgroundColor:deptColors.map(c=>c.replace('rgb','rgba').replace(')','), 0.6)')),borderColor:deptColors,borderWidth:1}]},
                options:{
                    responsive:true,maintainAspectRatio:false,
                    scales:{
                        y:{
                            beginAtZero:true,title:{display:true,text:'ê¸ˆì•¡ (ì›)'},
                            ticks:{callback:function(value){if(value>=1000000){return(value/1000000).toFixed(1)+'ë°±ë§Œ'}else if(value>=1000){return(value/1000).toFixed(0)+'ì²œ'}return value}}
                        }
                    },
                    plugins:{legend:{display:false},tooltip:{callbacks:{label:function(context){let label=context.dataset.label||'';if(label){label+=': '}if(context.parsed.y!==null){label+=formatCurrency(context.parsed.y)}return label}}}}
                }
            });
            if(chartId.includes('External')) externalCostChartInstance = newChart;
            else if(chartId.includes('AlwaysOn')) alwaysOnCostChartInstance = newChart;
        }

        function renderIncidentalCostDetails(data){
            const listContainer=document.getElementById('incidentalCostDetails');
            const aggregatedCosts=data.reduce((acc,item)=>{
                acc.carCost+=item.carCost;acc.publicTransitCost+=item.publicTransitCost;acc.lodgingEtcCost+=item.lodgingEtcCost;return acc;
            },{carCost:0,publicTransitCost:0,lodgingEtcCost:0});
            const totalSum=aggregatedCosts.carCost+aggregatedCosts.publicTransitCost+aggregatedCosts.lodgingEtcCost;
            const totalEmployees=new Set(data.map(item=>item.employeeId)).size; 
            const items=[
                {title:'ìì°¨ í•©ê³„',key:'carCost',cost:aggregatedCosts.carCost},
                {title:'ëŒ€ì¤‘êµí†µ/í•­ê³µ í•©ê³„',key:'publicTransitCost',cost:aggregatedCosts.publicTransitCost},
                {title:'ì‹ëŒ€/ìˆ™ë°•/ê¸°íƒ€ í•©ê³„',key:'lodgingEtcCost',cost:aggregatedCosts.lodgingEtcCost},
            ];
            listContainer.innerHTML=`
                <div class="space-y-3 p-4 bg-purple-100 rounded-lg">
                    <p class="text-lg font-bold text-gray-800 border-b pb-2">ì´ ë¶€ëŒ€ë¹„ìš© í•©ê³„: <span class="text-purple-600">${formatCurrency(totalSum)}</span></p>
                    ${items.map(item=>{
                        const avgCost=totalEmployees>0?item.cost/totalEmployees:0;
                        return`
                            <div class="flex justify-between text-base border-b border-purple-200 pb-1">
                                <span class="text-gray-700">${item.title}</span>
                                <div class="text-right">
                                    <span class="font-semibold text-purple-700 block">${formatCurrency(item.cost)}</span>
                                    <span class="text-xs text-purple-500">1ì¸ í‰ê· : ${formatCurrency(avgCost)}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                    <div class="flex justify-between text-base pt-2">
                        <span class="text-gray-900 font-bold">ì „ì²´ 1ì¸ í‰ê·  ë¶€ëŒ€ë¹„ìš© (ì´ì› ${totalEmployees}ëª… ê¸°ì¤€)</span>
                        <span class="font-bold text-purple-800">${formatCurrency(totalSum/(totalEmployees>0?totalEmployees:1))}</span>
                    </div>
                </div>
            `;
        }
        
        function renderDeptGoalSummary(department) {
            const goalSummaryContainer = document.getElementById('deptGoalSummary');
            if (!goalSummaryContainer) return;
            let departmentsToRender = [];
            if (department === 'ALL') { departmentsToRender = MAIN_DEPARTMENTS; } else { departmentsToRender = [department]; }
            const goalHtml = departmentsToRender.map(dept => {
                const goals = MOCK_DEPT_GOALS[dept] || MOCK_DEPT_GOALS['ê¸°íƒ€'];
                const color = DEPARTMENT_COLORS[dept];
                const bgColor = color.replace('rgb', 'rgba').replace(')', '), 0.1)');
                const goalLine = goals.map((goal, index) => 
                    `<span class="font-medium text-gray-700 whitespace-nowrap">${index + 1}. ${goal}</span>`
                ).join('<span class="text-gray-400 mx-1">/</span> ');
                return `
                    <div class="p-3 rounded-lg border-l-4 shadow-sm mb-2 last:mb-0" style="border-color: ${color}; background-color: ${bgColor};">
                        <p class="font-bold text-sm mb-2" style="color: ${color};">${dept} êµìœ¡ ëª©í‘œ:</p>
                        <div class="text-xs leading-relaxed flex flex-wrap gap-x-2">
                            ${goalLine}
                        </div>
                    </div>
                `;
            }).join('');
            goalSummaryContainer.innerHTML = `<div class="space-y-3">${goalHtml}</div>`;
        }

        function renderKeyTrainingInterests(department){
            const listContainer = document.getElementById('keyInterestsList');
            const deptSpan = document.getElementById('currentDeptKeywords');
            const dept = MOCK_KEYWORD_DATA[department] ? department : 'ALL';
            if (!listContainer || !deptSpan) return;
            deptSpan.textContent = dept === 'ALL' ? 'ì „ì²´' : dept;
            let itemsToRender = [];
            const isAllMode = dept === 'ALL';
            if (isAllMode) {
                MAIN_DEPARTMENTS.forEach(sourceDept => {
                    const keywords = MOCK_KEYWORD_DATA[sourceDept] || [];
                    const limitedKeywords = keywords.slice(0, 3);
                    if (limitedKeywords.length > 0) { itemsToRender.push({ department: sourceDept, keywords: limitedKeywords }); }
                });
                if (itemsToRender.length === 0) { itemsToRender.push({ department: 'ê³µí†µ', keywords: MOCK_KEYWORD_DATA['ALL'].slice(0, 5) }); }
            } else {
                const keywords = MOCK_KEYWORD_DATA[dept] || [];
                itemsToRender = keywords.slice(0, 5).map(keyword => ({ keyword: keyword, department: dept }));
            }
            if (itemsToRender.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 p-4">ë“±ë¡ëœ ì£¼ìš” ê´€ì‹¬ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                listContainer.classList.remove('flex', 'flex-wrap', 'gap-1.5', 'p-3');
                listContainer.classList.add('space-y-2', 'p-4'); 
                return;
            }
            if (isAllMode) {
                listContainer.classList.remove('flex', 'flex-wrap', 'gap-1.5', 'p-3');
                listContainer.classList.add('space-y-1', 'p-4'); 
                listContainer.innerHTML = itemsToRender.map(item => {
                    const deptKey = MAIN_DEPARTMENTS.includes(item.department) ? item.department : 'ê¸°íƒ€';
                    const deptHex = DEPARTMENT_COLORS[deptKey] || DEPARTMENT_COLORS['ê¸°íƒ€'];
                    const textColor = deptHex;
                    const bgColorRgba = deptHex.replace('rgb', 'rgba').replace(')','), 0.1)'); 
                    const keywordTags = item.keywords.map(keyword => `
                        <span class="px-3 py-1 text-sm font-semibold rounded-full shadow-sm inline-block"
                            style="color: ${textColor}; background-color: ${bgColorRgba}; border: 1px solid ${textColor.replace('rgb', 'rgba').replace(')','), 0.3)')};">
                            #${keyword}
                        </span>
                    `).join('');
                    return `
                        <div class="p-2 hover:bg-gray-50 rounded-lg transition duration-150 border-b border-gray-100 last:border-b-0">
                            <div class="flex flex-col space-y-2">
                                <div class="flex items-center">
                                    <span class="px-2 py-0.5 text-xs font-semibold rounded-md text-white flex-shrink-0" style="background-color: ${textColor};">
                                        ${item.department}
                                    </span>
                                </div>
                                <div class="flex flex-wrap gap-1 pl-2">
                                    ${keywordTags}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                listContainer.classList.remove('space-y-1', 'p-4');
                listContainer.classList.add('flex', 'flex-wrap', 'gap-1.5', 'p-3');
                listContainer.innerHTML = itemsToRender.map(item => {
                    const colors = ['bg-indigo-100 text-indigo-700', 'bg-blue-100 text-blue-700', 'bg-green-100 text-green-700', 'bg-yellow-100 text-yellow-700', 'bg-red-100 text-red-700'];
                    const randomColorClass = colors[Math.floor(Math.random() * colors.length)]; 
                    return `
                        <div>
                            <span class="px-3 py-1 text-sm font-semibold rounded-full ${randomColorClass} shadow-sm inline-block transition-all duration-300 hover:scale-[1.02]">
                                #${item.keyword}
                            </span>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function renderTopEmployees(filteredData){
            const topEmployeeContainerTitle = document.querySelector('#topEmployeeContainer h2');
            const listContainer = document.getElementById('topEmployeesList');
            const resultCountSpan = document.getElementById('topEmployeeCount');
            const allCombinedData = [...allEducationData, ...allAlwaysOnData];
            let targetData = allCombinedData;
            
            if (currentDepartment !== 'ALL') {
                targetData = targetData.filter(item => item.dept === currentDepartment);
            }

            if (currentDepartment !== 'ALL') {
                const departmentEmployees = getAggregatedEmployeeData(targetData);
                departmentEmployees.sort((a, b) => b.totalHours - a.totalHours); 
                topEmployeeContainerTitle.innerHTML = `${currentDepartment} ì„ì§ì› êµìœ¡ í˜„í™© (${departmentEmployees.length}ëª…)`;
                listContainer.innerHTML = departmentEmployees.map(employee => {
                    const totalHours = employee.totalHours.toFixed(1);
                    const hoursColor = employee.externalHours < MANDATORY_MINIMUM_HOURS ? 'text-red-600 font-extrabold' : 'text-green-600 font-bold';
                    employee.items.sort((a, b) => b.dateSort - a.dateSort);
                    const courseDetailHtml = employee.items.map(item => {
                        const periodHtml = item.period ? item.period.replace('~', '<br>~') : 'N/A';
                        return `
                            <div class="flex justify-between text-xs text-gray-700 py-1 border-b border-gray-100 last:border-b-0">
                                <span class="font-medium text-gray-600 w-1/4">${periodHtml}</span>
                                <span class="font-medium text-indigo-600 w-1/6">${item.source === 'ì‚¬ì™¸êµìœ¡' ? 'ì‚¬ì™¸' : 'ìƒì‹œ'}</span>
                                <span class="flex-1 truncate mx-2">${item.subject}</span>
                                <span class="font-semibold text-gray-800">${item.actualHours.toFixed(1)}h</span>
                            </div>
                        `;
                    }).join('');
                    return `
                        <div class="education-item p-3 bg-white border border-gray-200 rounded-lg shadow-sm hover:bg-gray-50 transition cursor-pointer" onclick="toggleDetail(this)">
                            <div class="flex justify-between items-center">
                                <div class="flex flex-col">
                                    <span class="font-bold text-gray-800">${employee.employeeName}</span>
                                    <span class="text-xs text-gray-500">${employee.employeeId} / ${employee.dept}</span>
                                </div>
                                <div class="text-right flex items-center space-x-2">
                                    <div>
                                        <span class="text-xs text-gray-500 block">ì´ ì´ìˆ˜ ì‹œê°„</span>
                                        <span class="text-lg ${hoursColor} block">${totalHours} ì‹œê°„</span>
                                    </div>
                                    <svg class="w-4 h-4 text-gray-500 toggle-icon transition-transform duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                            <div class="detail-content pt-3 mt-2 border-t border-gray-100 space-y-1">
                                <h4 class="font-bold text-gray-700 mb-2">ì´ êµìœ¡ ì´ë ¥ (${employee.items.length}ê±´, ìµœì‹ ìˆœ):</h4>
                                <div class="bg-gray-50 p-3 rounded-lg space-y-1">
                                    <div class="flex justify-between text-xs font-bold text-gray-700 border-b pb-1 mb-1">
                                        <span class="w-1/4">ê¸°ê°„</span>
                                        <span class="w-1/6">êµ¬ë¶„</span>
                                        <span class="flex-1 mx-2">êµìœ¡ëª…</span>
                                        <span>ì‹œê°„</span>
                                    </div>
                                    ${courseDetailHtml || '<p class="text-xs text-center text-gray-400 p-2">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                if (departmentEmployees.length === 0) {
                    listContainer.innerHTML = '<p class="text-center text-gray-500 p-4">í˜„ì¬ ì¡°ê±´ì— í•´ë‹¹í•˜ëŠ” ì„ì§ì› êµìœ¡ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                }
                if(resultCountSpan) resultCountSpan.textContent = ''; 
                return;
            }
            topEmployeeContainerTitle.innerHTML = `ìµœê³  ì´ìˆ˜ ì‹œê°„ ì§ì› í˜„í™© (<span id="topEmployeeCount">0</span>ëª…)`;
            const aggregatedData=getAggregatedEmployeeData(targetData);
            const topEmployees={};
            aggregatedData.forEach(employee=>{
                const dept=employee.dept||'ê¸°íƒ€';
                if(!topEmployees[dept]||employee.totalHours>topEmployees[dept].totalHours){topEmployees[dept]=employee}
            });
            const topList=Object.values(topEmployees).sort((a,b)=>b.totalHours-a.totalHours);
            document.getElementById('topEmployeeCount').textContent=topList.length;
            listContainer.innerHTML='';
            if(topList.length===0){listContainer.innerHTML='<p class="text-center text-gray-500 p-4">í•´ë‹¹í•˜ëŠ” ì§ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';return}
            topList.forEach(employee=>{
                const totalHours=employee.totalHours.toFixed(1);
                employee.items.sort((a,b)=>b.dateSort-a.dateSort);
                const detailHtml=employee.items.map(item=>`
                    <p class="text-xs text-gray-600 border-b border-gray-200 py-1">
                        <span class="font-semibold text-indigo-600">${item.source==='ì‚¬ì™¸êµìœ¡'?'ì‚¬ì™¸':'ìƒì‹œ'}</span>: 
                        ${item.subject} (${item.actualHours.toFixed(1)}ì‹œê°„)
                    </p>
                `).join('');
                listContainer.innerHTML+=`
                    <div class="education-item bg-gray-50 p-3 rounded-lg shadow-sm border border-indigo-200 hover:shadow-md transition duration-200 cursor-pointer" onclick="toggleDetail(this)">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-2">
                                <span class="text-xs font-semibold px-2 py-0.5 bg-indigo-100 text-indigo-800 rounded-full">${employee.dept}</span>
                                <span class="font-bold text-gray-800">${employee.employeeName}</span>
                            </div>
                            <div class="flex items-center text-sm font-semibold text-green-600">
                                ${totalHours} ì‹œê°„
                                <svg class="w-4 h-4 text-gray-500 toggle-icon transition-transform duration-300 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                        </div>
                        <div class="detail-content pt-2 pb-2 mt-2 space-y-1">
                            <h4 class="font-bold text-gray-700 mb-1">ì´ êµìœ¡ ì´ë ¥ (ì´ ${employee.items.length}ê±´):</h4>
                            ${detailHtml}
                        </div>
                    </div>
                `;
            });
        }

        function renderMandatoryComplianceList(filteredData){
            const aggregatedData=getAggregatedEmployeeData(filteredData);
            const nonCompliant=aggregatedData.filter(employee=>employee.externalHours<MANDATORY_MINIMUM_HOURS).sort((a,b)=>a.externalHours-b.externalHours);
            const listContainer=document.getElementById('mandatoryComplianceList');
            document.getElementById('mandatoryCount').textContent=nonCompliant.length;
            listContainer.innerHTML='';
            if(nonCompliant.length===0){
                listContainer.innerHTML='<p class="text-center text-gray-500 p-4 w-full">ë¯¸ì™„ë£Œ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            const groupedByDept=nonCompliant.reduce((acc,employee)=>{
                const dept=employee.dept||'ê¸°íƒ€';
                if(!acc[dept]){acc[dept]=[]}
                acc[dept].push(employee);
                return acc;
            },{});
            const departments=Object.keys(groupedByDept).sort();
            let departmentHtml='';
            departments.forEach(dept=>{
                const employees=groupedByDept[dept];
                const deptColorHex=DEPARTMENT_COLORS[dept]||DEPARTMENT_COLORS['ê¸°íƒ€'];
                const bgColorRgba=deptColorHex.replace('rgb','rgba').replace(')','), 0.1)');
                const textColor=deptColorHex; 
                const borderColorRgba=textColor.replace('rgb','rgba').replace(')','), 0.3)');
                const sectionBorderColor=textColor.replace('rgb','rgba').replace(')','), 0.4)');
                const dividerColor=textColor.replace('rgb','rgba').replace(')','), 0.2)');
                const employeeTags=employees.map(employee=>`
                    <div class="px-2 py-1 text-xs rounded-full border flex items-center space-x-1" 
                        style="border-color:${borderColorRgba} !important;color:${textColor};" 
                        title="${employee.employeeId} / ${employee.email}">
                        <span class="font-bold">${employee.employeeName}</span>
                        <span class="text-gray-600 font-medium ml-0">(${employee.externalHours.toFixed(1)}h)</span>
                        <span class="text-gray-500 text-[10px] truncate ml-1">${employee.email}</span>
                    </div>
                `).join('');
                departmentHtml+=`
                    <div class="w-full p-3 rounded-lg shadow-sm border mb-4" style="border-color:${sectionBorderColor};background-color:${bgColorRgba};">
                        <h4 class="text-sm font-extrabold mb-2 pb-1 border-b" style="color:${textColor};border-color:${dividerColor}">
                            ${dept} (${employees.length}ëª…)
                        </h4>
                        <div class="flex flex-wrap gap-1.5 max-h-32 overflow-y-auto">
                            ${employeeTags}
                        </div>
                    </div>
                `;
            });
            listContainer.innerHTML=departmentHtml;
        }

        function calculateDashboardMetrics(data){
            const employeeTargets = getAggregatedEmployeeTargets(data);
            const uniqueEmployees = new Set(Object.keys(employeeTargets));
            let totalActualHours = Object.values(employeeTargets).reduce((sum, e) => sum + e.actualHours, 0);
            let sumOfIndividualTargetHours = Object.values(employeeTargets).reduce((sum, e) => sum + e.plannedTargetHours, 0);
            let externalCostTotal=0;
            let alwaysOnCostTotal=0;
            let incidentalCostTotal=0;
            data.forEach(item=>{
                if(item.source==='ì‚¬ì™¸êµìœ¡'){
                    externalCostTotal+=item.actualCost;
                    incidentalCostTotal+=item.incidentalCostTotal;
                }else if(item.source==='ìƒì‹œí•™ìŠµì§€ì›'){
                    alwaysOnCostTotal+=item.actualCost;
                    incidentalCostTotal+=item.incidentalCostTotal;
                }
            });
            const totalEmployees=uniqueEmployees.size;
            const mandatoryTotalGoal = totalEmployees * MANDATORY_MINIMUM_HOURS;
            const targetHoursGoal = Math.max(sumOfIndividualTargetHours, mandatoryTotalGoal);
            const targetAchievementRate=targetHoursGoal>0?((totalActualHours/targetHoursGoal)*100).toFixed(1)+'%':'N/A';
            const avgExternalCostPerPerson = totalEmployees > 0 ? externalCostTotal / totalEmployees : 0; 
            const avgAlwaysOnCostPerPerson = totalEmployees > 0 ? alwaysOnCostTotal / totalEmployees : 0;
            const actualBudgetUsed = externalCostTotal + alwaysOnCostTotal;
            const budgetUsageRate = (actualBudgetUsed / ALLOCATED_BUDGET) * 100;
            return{
                totalEmployees,targetAchievementRate,externalCostTotal,alwaysOnCostTotal,incidentalCostTotal,
                avgExternalCostPerPerson,avgAlwaysOnCostPerPerson,actualBudgetUsed,budgetUsageRate,
            };
        }
        
        function renderDashboard(metrics,data){
            const achievementCard = document.getElementById('kpi-target-achievement-card');
            if (achievementCard) {
                if (currentDepartment === 'ALL') {
                    achievementCard.querySelector('#kpi-target-achievement').textContent = '';
                } else {
                    achievementCard.querySelector('#kpi-target-achievement').textContent = metrics.targetAchievementRate;
                }
            }
            document.getElementById('kpi-incidental-cost').textContent=formatCurrency(metrics.incidentalCostTotal);
            document.getElementById('kpi-incidental-cost-card').querySelector('p').textContent = 'ë¶€ëŒ€ë¹„ìš© ì´ì•¡';

            const kpiBudgetStatusCard = document.getElementById('kpi-budget-status-card');
            if (currentDepartment === 'ALL') {
                kpiBudgetStatusCard.querySelector('p').textContent = 'ì‚¬ìš© ì˜ˆì‚° / í¸ì„± ì˜ˆì‚°';
                kpiBudgetStatusCard.querySelector('h3').innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-lg font-bold text-gray-800">${formatCurrency(metrics.actualBudgetUsed)}</span>
                        <span class="text-base font-extrabold ${metrics.budgetUsageRate > 100 ? 'text-red-600' : 'text-green-600'}">
                            ${metrics.budgetUsageRate.toFixed(1)}%
                        </span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1 mb-2">í¸ì„± ì˜ˆì‚°: ${formatCurrency(ALLOCATED_BUDGET)}</div>
                    <div class="mt-2 space-y-0.5 text-xs pt-1 border-t border-green-200">
                        <div class="flex justify-between items-center cursor-pointer hover:bg-green-100 p-0.5 -mx-0.5 rounded" onclick="toggleChart('externalCost')">
                            <span class="font-medium text-yellow-700 flex items-center text-[10px]">
                                ì‚¬ì™¸êµìœ¡ ì‚¬ìš©
                                <svg class="w-3 h-3 text-yellow-500 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                            </span>
                            <span class="font-bold text-sm text-gray-800">${formatCurrency(metrics.externalCostTotal)}</span>
                        </div>
                        <div class="flex justify-between items-center cursor-pointer hover:bg-green-100 p-0.5 -mx-0.5 rounded" onclick="toggleChart('alwaysOnCost')">
                            <span class="font-medium text-red-700 flex items-center text-[10px]">
                                ìƒì‹œí•™ìŠµì§€ì› ì‚¬ìš©
                                <svg class="w-3 h-3 text-red-500 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7-7" /></svg>
                            </span>
                            <span class="font-bold text-sm text-gray-800">${formatCurrency(metrics.alwaysOnCostTotal)}</span>
                        </div>
                    </div>
                `;
            } else {
                kpiBudgetStatusCard.querySelector('p').textContent = 'êµìœ¡ ì´ì•¡ ë° 1ì¸ í‰ê·  ë¹„ìš© (ì‚¬ì™¸/ìƒì‹œ)'; 
                kpiBudgetStatusCard.querySelector('h3').innerHTML = `
                    <div class="space-y-0.5 text-xs pt-0">
                        <div class="border-b border-gray-200 pb-0.5">
                            <h4 class="font-bold text-sm text-gray-700 mb-0.5">ì´ì•¡ (${currentDepartment})</h4>
                            <div class="flex justify-between items-center text-yellow-700">
                                <span class="font-medium text-[11px]">ì‚¬ì™¸êµìœ¡ ì‚¬ìš©:</span>
                                <span class="font-bold text-sm">${formatCurrency(metrics.externalCostTotal)}</span>
                            </div>
                            <div class="flex justify-between items-center text-red-700">
                                <span class="font-medium text-[11px]">ìƒì‹œí•™ìŠµì§€ì› ì‚¬ìš©:</span>
                                <span class="font-bold text-sm">${formatCurrency(metrics.alwaysOnCostTotal)}</span>
                            </div>
                        </div>
                        <div class="pt-0">
                            <h4 class="font-bold text-sm text-gray-700 mb-0.5">1ì¸ í‰ê·  ë¹„ìš©</h4>
                            <div class="flex justify-between items-center text-orange-700">
                                <span class="font-medium text-[11px]">ì‚¬ì™¸êµìœ¡ ì‚¬ìš©:</span>
                                <span class="font-bold text-sm">${formatCurrency(metrics.avgExternalCostPerPerson)}</span>
                            </div>
                            <div class="flex justify-between items-center text-pink-700">
                                <span class="font-medium text-[11px]">ìƒì‹œí•™ìŠµì§€ì› ì‚¬ìš©:</span>
                                <span class="font-bold text-sm">${formatCurrency(metrics.avgAlwaysOnCostPerPerson)}</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            renderAllCharts(data); 
        }
        
        function handleDepartmentFilter(event){
            const newDept=event.currentTarget.getAttribute('data-dept');
            
            // --- [ìˆ˜ì •ëœ ë¶€ë¶„] íŠ¹ì • ì‚¬ì—…ë³¸ë¶€ ë²„íŠ¼ í´ë¦­ ì‹œ í•˜ë‚˜ì˜ HTML íŒŒì¼ë¡œ ì´ë™ ---
            const departmentPages = ['FPCBì‚¬ì—…ë³¸ë¶€', 'FSì‚¬ì—…ë³¸ë¶€', 'ê²½ì˜ì§€ì›ë³¸ë¶€', 'ì¸ê³µì‹ ì¥ì‚¬ì—…ë³¸ë¶€'];
            if (departmentPages.includes(newDept)) {
                // FSì‚¬ì—…ë³¸ë¶€ ë“±ì„ í´ë¦­í•˜ë”ë¼ë„ FPCBì‚¬ì—…ë³¸ë¶€.htmlë¡œ ì—°ê²°í•˜ë„ë¡ ìˆ˜ì •
                window.location.href = `FPCBì‚¬ì—…ë³¸ë¶€.html`;
                return; // í˜ì´ì§€ë¥¼ ì´ë™í•˜ë¯€ë¡œ ì—¬ê¸°ì„œ í•¨ìˆ˜ ì‹¤í–‰ì„ ì¢…ë£Œ
            }
            // --- [ìˆ˜ì •ëœ ë¶€ë¶„] ë ---

            // 'ALL' ë²„íŠ¼ (ì „ì²´ ë³´ê¸°)ì— ëŒ€í•œ ê¸°ì¡´ í•„í„°ë§ ë° ìŠ¤íƒ€ì¼ë§ ë¡œì§ (í˜„ì¬ í˜ì´ì§€ ìœ ì§€)
            if(currentDepartment===newDept)return;
            currentDepartment=newDept;
            document.querySelectorAll('.dept-btn').forEach(btn=>{
                const isSelected=btn.getAttribute('data-dept')===newDept;
                btn.classList.remove('bg-blue-600','hover:bg-blue-700','text-white','shadow-md');
                btn.classList.add('text-gray-700','bg-gray-200','hover:bg-gray-300');
                if(isSelected){
                    btn.classList.remove('text-gray-700','bg-gray-200','hover:bg-gray-300');
                    btn.classList.add('bg-blue-600','hover:bg-blue-700','text-white','shadow-md');
                }
            });
            filterAndSortData();
        }

        function filterAndSortData(){
            const allCombinedData=[...allEducationData,...allAlwaysOnData];
            let filteredData=allCombinedData;
            if(currentDepartment!=='ALL'){filteredData=filteredData.filter(item=>item.dept===currentDepartment)}
            filteredData.sort((a,b)=>b.dateSort-a.dateSort);
            renderKeyTrainingInterests(currentDepartment);
            renderDeptGoalSummary(currentDepartment);
            const metrics=calculateDashboardMetrics(filteredData);
            renderDashboard(metrics,filteredData);
            renderTopEmployees(filteredData);
            renderMandatoryComplianceList(filteredData);
            return filteredData;
        }
        
        document.addEventListener('DOMContentLoaded',async()=>{
            try{
                const erpMap=await fetchERPData();
                allEducationData=await fetchEducationData(EXTERNAL_RANGE,'ì‚¬ì™¸êµìœ¡',erpMap);
                allAlwaysOnData=await fetchEducationData(ALWAYS_ON_RANGE,'ìƒì‹œí•™ìŠµì§€ì›',erpMap);
                const keywordLoading = document.getElementById('keywordLoading');
                if (keywordLoading) { keywordLoading.remove(); }
                filterAndSortData();
            }catch(error){
                console.error("Failed to load education data (outside fetch):",error);
            }
            document.querySelectorAll('.dept-btn').forEach(btn=>{btn.addEventListener('click',handleDepartmentFilter)});
        });
    </script>
</body>
</html>